# Feature Plan: Airforce Page Enhancements - Video Model, Cooldown Timer, and UI Refinements

## Overview

This feature adds video generation support to the Airforce page, implements a 60-second cooldown timer, and refines the UI by removing unused parameters (size and seed).

### Summary of Changes

| Change | Description |
|--------|-------------|
| Remove size dropdown | Airforce only accepts 1024x1024 for image models |
| Remove seed input | Airforce models do not use seed parameter |
| Add grok-imagine-video model | New video generation model with aspectRatio parameter |
| Add aspectRatio dropdown | Conditional dropdown for video model only (1:1, 2:3, 3:2) |
| Add cooldown timer | 60-second countdown on Generate button after successful generation |
| Video support in gallery | Display videos with hover autoplay in gallery grid |
| Video metadata | Embed metadata in MP4 files using EXIF-style approach |

---

## Files to Modify

### 1. `gui/widgets/airforce_page.py`

**Current State:**
- `MODELS = ["grok-imagine", "imagen-4"]`
- `SIZES = ["1024x1024", "1344x768", "768x1344"]`
- Has size_btn, size_dropdown, seed_input widgets
- Top bar: Generate → Positive → Negative → Model → Size → Seed

**Changes Required:**

1. **Update MODELS constant** (line 28):
   ```python
   MODELS = ["grok-imagine", "imagen-4", "grok-imagine-video"]
   ```

2. **Add ASPECT_RATIOS constant**:
   ```python
   ASPECT_RATIOS = ["1:1", "2:3", "3:2"]
   DEFAULT_ASPECT_RATIO = "1:1"
   ```

3. **Remove SIZES constant** (no longer needed)

4. **Add cooldown timer state**:
   ```python
   COOLDOWN_SECONDS = 60
   ```

5. **Update `__init__`** to add:
   - `self.current_aspect_ratio = self.DEFAULT_ASPECT_RATIO`
   - `self.cooldown_remaining = 0`
   - `self.cooldown_timer = QTimer()` for countdown updates

6. **Modify `_build_ui`** (line 57):
   - Remove `size_btn` and `seed_input` widgets
   - Add `aspect_ratio_btn` (initially hidden)
   - Add `aspect_ratio_dropdown`
   - Top bar order: Generate → Positive → Negative → Model → [aspectRatio if video model]

7. **Add `_on_model_selected` logic** to show/hide aspect ratio dropdown:
   - If model == "grok-imagine-video": show aspect_ratio_btn
   - Else: hide aspect_ratio_btn

8. **Add cooldown timer methods**:
   - `_start_cooldown()`: Called on successful generation, starts 1-second timer
   - `_update_cooldown()`: Decrements counter, updates button text
   - `_end_cooldown()`: Resets button to "Generate"

9. **Update `_on_generate_clicked`** to pass aspect_ratio for video model

10. **Update `_on_image_generated`** to start cooldown timer

11. **Update `_save_to_config` and `_load_from_config`**:
    - Remove airforce_size, airforce_seed
    - Add airforce_aspect_ratio

### 2. `core/services/airforce_service.py`

**Current State:**
- `AirforceWorker.__init__` accepts: prompt, negative_prompt, model, size, seed
- Payload includes size and optional seed

**Changes Required:**

1. **Update `AirforceWorker.__init__`** (line 27):
   - Remove `size` and `seed` parameters
   - Add `aspect_ratio` parameter (optional, for video model)

2. **Update payload construction** (line 52):
   - Always use `"size": "1024x1024"` for all models
   - For grok-imagine-video: add `"aspectRatio": aspect_ratio`
   - Remove seed from payload entirely

3. **Add video handling**:
   - Detect if response is video data vs image data
   - Save with `.mp4` extension for video model
   - Use `save_generated_video` for video content

4. **Add `save_generated_video` function** or extend `save_generated_image`:
   - Save video bytes to `.mp4` file
   - Embed metadata using MP4 metadata atoms (EXIF-style)

5. **Update `generate_image` method signature** in `AirforceService` class (line 164):
   - Remove size and seed parameters
   - Add aspect_ratio parameter

### 3. `core/utils.py`

**Changes Required:**

1. **Add `save_generated_video` function**:
   ```python
   def save_generated_video(
       video_data: bytes,
       prompt: str,
       negative_prompt: str,
       model: str,
       aspect_ratio: str,
       service: str,
   ) -> str:
   ```

2. **Video metadata embedding**:
   - Use `mutagen` or `ffmpeg` library to embed metadata in MP4
   - Metadata fields: Prompt, Negative, Model, AspectRatio, Service
   - Fallback: Save without metadata if library unavailable

3. **Add video file extension handling**:
   - Timestamp-based filename with `.mp4` extension
   - Same collision handling as images (append _1, _2, etc.)

### 4. `gui/widgets/gallery_page.py`

**Changes Required:**

1. **Update `GalleryService` integration** to handle video files

2. **Modify `GalleryItemWidget`**:
   - Add video detection based on file extension
   - Add video widget (QVideoWidget or custom) for hover playback
   - Show play icon overlay for videos
   - Implement hover detection for autoplay

3. **Add video playback logic**:
   - On mouse enter: Start video playback (loop, audio enabled)
   - On mouse leave: Stop playback, show first frame
   - Use QMediaPlayer or QVideoWidget from PyQt6

4. **Update `_parse_metadata` in GalleryService** to handle MP4 metadata

### 5. `core/services/gallery_service.py`

**Changes Required:**

1. **Update `get_images` method** (line 25):
   - Change glob from `*.jpg` to include `*.mp4`
   - Or use separate video handling

2. **Add `is_video` field to `ImageMetadata` dataclass**:
   ```python
   @dataclass
   class ImageMetadata:
       filepath: str
       prompt: str
       service: str
       model: str
       timestamp: str
       is_video: bool = False
   ```

3. **Add `_parse_video_metadata` method**:
   - Extract metadata from MP4 files
   - Use mutagen or ffmpeg to read metadata atoms

4. **Update filter logic** to include videos in "Airforce" filter

### 6. `core/config.py`

**Changes Required:**

1. **Update `_DEFAULTS`**:
   - Remove `airforce_size` and `airforce_seed`
   - Add `airforce_aspect_ratio: "1:1"`

---

## Implementation Details

### Phase 1: Data Layer - Configuration and Constants

1. Update `core/config.py` - Remove size/seed, add aspect_ratio
2. Update constants in `gui/widgets/airforce_page.py`
3. Update `core/services/gallery_service.py` - Add is_video field

### Phase 2A: Service Layer - Airforce Service

1. Modify `AirforceWorker` to handle video responses
2. Add aspect_ratio parameter handling
3. Implement video save with metadata
4. Remove size/seed from API payload

### Phase 2B: Service Layer - Utils

1. Add `save_generated_video` function
2. Implement MP4 metadata embedding

### Phase 3A: UI Layer - Airforce Page Controls

1. Remove size_btn and seed_input from UI
2. Add aspect_ratio_btn (conditional visibility)
3. Implement model selection logic for aspect ratio visibility
4. Update config save/load

### Phase 3B: UI Layer - Cooldown Timer

1. Add cooldown timer state and QTimer
2. Implement countdown display on Generate button
3. Connect to successful generation signal

### Phase 3C: UI Layer - Gallery Video Support

1. Add video detection in GalleryItemWidget
2. Implement hover autoplay for videos
3. Add play icon overlay

---

## Key Algorithms

### Conditional Aspect Ratio Display

```
On model selection change:
    If selected_model == "grok-imagine-video":
        Show aspect_ratio_btn
        Enable aspect_ratio_dropdown
    Else:
        Hide aspect_ratio_btn
        aspect_ratio = "1:1"  # Default, not sent in API
```

### Cooldown Timer

```
On successful generation:
    cooldown_remaining = 60
    Start QTimer with 1000ms interval
    
On timer tick:
    cooldown_remaining -= 1
    If cooldown_remaining > 0:
        button.setText(f"Generate ({cooldown_remaining})")
    Else:
        button.setText("Generate")
        Stop timer
```

### Video Detection in Gallery

```
On GalleryItemWidget.set_data:
    If filepath ends with ".mp4":
        is_video = True
        Load first frame as thumbnail
        Add play icon overlay
        Setup QMediaPlayer with QVideoWidget
    Else:
        is_video = False
        Use existing image display logic
```

### Video Hover Playback

```
On mouse enter (video item):
    Start video playback
    Set loop mode
    Unmute audio

On mouse leave (video item):
    Stop playback
    Seek to beginning
    Show first frame thumbnail
```

---

## API Payload Changes

### Image Models (imagen-4, grok-imagine)

```python
payload = {
    "model": "grok-imagine",  # or "imagen-4"
    "prompt": "...",
    "n": 1,
    "size": "1024x1024",
    "response_format": "b64_json",
    "sse": True,
}
# negative_prompt added if provided
```

### Video Model (grok-imagine-video)

```python
payload = {
    "model": "grok-imagine-video",
    "prompt": "...",
    "n": 1,
    "size": "1024x1024",
    "response_format": "b64_json",
    "sse": True,
    "aspectRatio": "1:1",  # or "2:3", "3:2"
}
# negative_prompt added if provided
# NOTE: image_urls parameter exists for image-to-video but not implemented
```

---

## Verbatim Requirements from User

1. **Size removal**: "airforce only accepts 1024x1024 as it's size parameter for both imagen-4 and grok-imagine. As such, we're removing size from the top bar."

2. **Video model**: "We're adding another model for airforce. It's name is `grok-imagine-video`. And yes, it actually produces videos with audio instead of images."

3. **Aspect ratio**: "Valid options for aspectRatio are 1:1, 2:3, and 3:2. Size is not adjustable."

4. **Image-to-video note**: "It also accepts image_urls for image-to-video. We could use this, but we're not integrating it at this time. Just make a note of it /comment so that we don't forget it exists for future implementation."

5. **Conditional aspect ratio UI**: "The top bar should display aspectRatio only when the model is grok-imagine-video. No aspectRatio parameter for the imagen-4 and grok-imagine picture model. aspectRatio should use the dropdown hover logic."

6. **Cooldown timer**: "The airforce service itself imposes a 60-second cooldown between successful generations. I want to convey this in the app in some way. Maybe a counting down timer e.g. Generate (60), Generate (59) on the button face itself. This would not act as a hard controls lock or prevent requests, it's simple a friendly timer that starts after a successful return/download to remind the user, but never prevent user actions."

7. **Global cooldown**: "This timer is global for the API key being used, so all models share the cooldown."

8. **Video format**: "mp4"

9. **Timer persistence**: "No persistence, lightweight timer."

10. **Video display**: "Static first frame, autoplays on mouse hover (and loops), audio not muted on play, left click opens the file path in explorer like images."

11. **Video metadata**: "exif"

12. **Seed removal**: "none of the airforce models use Seed parameter either. It's to be removed from the airforce page topbar."

13. **Top bar layout**: "Imagen-4, grok-imagine, and grok-imagine-video all use: Generate -> Positive prompt -> negative prompt -> model selector. Then grok-imagine-video will have one more dropdown for aspectRatio, placed after model selector."

---

## Dependencies

### New Dependencies Required

| Library | Purpose |
|---------|---------|
| `mutagen` | MP4 metadata read/write |
| `PyQt6.QtMultimedia` | Video playback in gallery |
| `PyQt6.QtMultimediaWidgets` | QVideoWidget for video display |

### requirements.txt Update

```
mutagen>=1.47.0
```

Note: PyQt6.QtMultimedia and PyQt6.QtMultimediaWidgets are typically included with PyQt6 installation.

---

## Future Considerations

### Image-to-Video (Not Implemented)

The grok-imagine-video model supports an `image_urls` parameter for image-to-video generation:

```python
payload = {
    "model": "grok-imagine-video",
    "prompt": "...",
    "image_urls": ["https://example.com/image.png"],
    # ... other parameters
}
```

This feature is documented for future implementation but not included in this plan.

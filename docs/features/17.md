### TASK

You have a unique task in that you are going to be attempting to improve a solution that was already produced for the original task request.

The issue with the solution is that the performance in the app and gallery page is quite bad. It's not as responsive as I'd like, and feels sluggish. Imagine 0.5-1 seconds between clicking next page and the items populate. Or typing into the search bar, and having it lag behind your keystrokes by a decent margin.

Please investigate and produce the best meaningful improvements you can think of.

The only constraint is don't write thumbnail files to disk.

Below you will find the ORIGINAL TASK REQUEST, the SOLUTON CONTEXT, which contains the working solution files, and CONTEXT which contains the current app's production files.

---

### ORIGINAL TASK REQUEST

Implement Gallery Page enhancements. You have full creative control to design any implementation that covers these goals:

# HOTKEY

1. Hotkey/shortcut: User can navigate pagination pages using mouse scroll wheel up/down, or left/right arrow keys. Focus-centric design: hotkeys only work if the mouse is located anywhere on the media panel (so we don't accidentally interrupt users working in the response panel). Consider some kind of over-arching refactoring here as well to define hotkeys as per panel, I think the current hotkey system is global(?).

# TOP BAR 

We are not utilizing the top bar of our Gallery page very well. We're going to fill in the empty spacing by:

2. Move the current service filtering drop down to the left, instead of the right.

3. To the right of the service filtering, and left of the centered pagination pages, add a Favorites button. This favorites acts as an independent filtering view of the items. The favorites does not have a drop down, it just toggles on/off when used. Users can set an image as a favorite in the GUI by right clicking the item. That's it - don't go overengineering a context menu. Draw a very thin gold border around favored items. Pick a simple approach for flagging/reading items as favorites, don't try manipulating exif.

4. To the right of the pagination pages, add a search bar input field. This search bar acts as in independent filtering view of the items. It searches against the (positive) prompt text. The pages and items update per character. Quick and responsive design.

Filtering hierarchy: Service -> Favorites -> Search Bar

Our Top Bar now looks like:

Service Filter -> Favorites Toggle -> Pagination Pages (CENTERED) -> Search Bar

In the final top bar design, ensure all available space is being consumed. It's just plain ugly to have blank space, and the Gallery top bar isn't matching our other page designs fully. (minimal waste, maximum content area utilized. keep top bar height the same)

### PROJECT 

Image Assistant is a PyQt6 desktop application that transforms user concepts into optimized image generation prompts via AI services (Gemini, NVIDIA NIM), with integrated text-to-image synthesis through Pollinations, Airforce, and Perchance APIs.

### DELIVERABLES

IMPORTANT: Write your outputs and modifications against the SOLUTION CONTEXT files, and not the production CONTEXT files.

Please output a brief summary including any design choices, and the updated or new files where applicable. You have authority to create, delete, or consolidate services or modules. If only small changes to existing files are required, please output them in

SEARCH: 

```
...stuff...
``` 

REPLACE:

```
...stuff...
``` 

style blocks. 

Never include backwards compatibility, if you want to rename a handler or file, then rename it. We'll deal with unexpected fallout to ensure names match expected behaviors.

### SOLUTION CONTEXT

```gallery_service.py
# core/services/gallery_service.py
"""
Gallery Service - Reads and caches image metadata from the generated images directory.
"""

from pathlib import Path
from dataclasses import dataclass
from typing import List, Dict
import json

@dataclass
class ImageMetadata:
    filepath: str
    prompt: str
    service: str
    model: str
    timestamp: str
    negative_prompt: str = ""
    size: str = ""
    seed: str = ""
    guidance_scale: str = ""
    is_favorite: bool = False


class GalleryService:
    def __init__(self):
        self._cache: Dict[str, tuple[float, ImageMetadata]] = {}
        self.images_dir = Path("images")
        self.images_dir.mkdir(exist_ok=True)
        self.favorites_file = self.images_dir / "favorites.json"
        self._favorites = set()
        self._load_favorites()
        
    def _load_favorites(self):
        if self.favorites_file.exists():
            try:
                with open(self.favorites_file, 'r') as f:
                    data = json.load(f)
                    self._favorites = set(data)
            except Exception:
                pass
                
    def _save_favorites(self):
        try:
            with open(self.favorites_file, 'w') as f:
                json.dump(list(self._favorites), f)
        except Exception:
            pass

    def toggle_favorite(self, filepath: str) -> bool:
        filename = Path(filepath).name
        if filename in self._favorites:
            self._favorites.remove(filename)
            is_fav = False
        else:
            self._favorites.add(filename)
            is_fav = True
        self._save_favorites()
        if filepath in self._cache:
            self._cache[filepath][1].is_favorite = is_fav
        return is_fav

    def is_favorite(self, filepath: str) -> bool:
        return Path(filepath).name in self._favorites
        
    def get_images(self, filter_service: str = "All", favorites_only: bool = False, search_query: str = "") -> List[ImageMetadata]:
        images = []
        if not self.images_dir.exists():
            return images
            
        for p in self.images_dir.glob("*.jpg"):
            try:
                mtime = p.stat().st_mtime
                filepath_str = str(p)
                
                # Check cache mapping via modified time
                if filepath_str in self._cache and self._cache[filepath_str][0] == mtime:
                    meta = self._cache[filepath_str][1]
                else:
                    meta = self._parse_metadata(p)
                    meta.is_favorite = self.is_favorite(filepath_str)
                    self._cache[filepath_str] = (mtime, meta)
                    
                if filter_service != "All" and meta.service.lower() != filter_service.lower():
                    continue
                if favorites_only and not meta.is_favorite:
                    continue
                if search_query and search_query.lower() not in meta.prompt.lower():
                    continue
                    
                images.append(meta)
            except Exception:
                continue
                
        # Sort by filepath descending (newest timestamp first)
        images.sort(key=lambda x: x.filepath, reverse=True)
        return images
        
    def _parse_metadata(self, filepath: Path) -> ImageMetadata:
        prompt = ""
        service = "Unknown"
        model = "Unknown"
        timestamp = filepath.stem
        negative_prompt = ""
        size = ""
        seed = ""
        guidance_scale = ""

        try:
            from PIL import Image
            with Image.open(filepath) as img:
                exif = img.getexif()
                if exif and 0x010E in exif:
                    meta_str = exif[0x010E]
                    parts = [p.strip() for p in meta_str.split("|")]
                    for part in parts:
                        if part.startswith("Prompt:"):
                            prompt = part[7:].strip()
                        elif part.startswith("Service:"):
                            service = part[8:].strip()
                        elif part.startswith("Model:"):
                            model = part[6:].strip()
                        elif part.startswith("Negative:"):
                            negative_prompt = part[9:].strip()
                        elif part.startswith("Size:"):
                            size = part[5:].strip()
                        elif part.startswith("Seed:"):
                            seed = part[5:].strip()
                        elif part.startswith("GuidanceScale:"):
                            guidance_scale = part[14:].strip()
        except Exception:
            pass

        return ImageMetadata(
            str(filepath), prompt, service, model, timestamp,
            negative_prompt, size, seed, guidance_scale,
            is_favorite=self.is_favorite(str(filepath))
        )
```

```gallery_page.py
# gui/widgets/gallery_page.py
"""
Gallery Page - Displays generated images in a responsive 4x3 grid.
Includes pagination, filtering, and prompt copying functionalities.
"""

from datetime import datetime

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, QGridLayout, QSizePolicy
)
from PyQt6.QtCore import pyqtSignal, Qt, QTimer, QEvent
from PyQt6.QtGui import QCursor

from gui.widgets.image_gen_common import ImageDisplay, BTN_DROPDOWN, make_dropdown
from core.utils import reveal_file_in_explorer
from core.services.gallery_service import GalleryService


class ElidedLabel(QLabel):
    """A QLabel that elides its text on the right if it exceeds widget width."""
    clicked = pyqtSignal()
    
    def __init__(self, text="", parent=None):
        super().__init__(text, parent)
        self._full_text = text
        self.setSizePolicy(QSizePolicy.Policy.Ignored, QSizePolicy.Policy.Fixed)
        
    def setText(self, text):
        self._full_text = text
        super().setText(text)
        self.update_elision()
        
    def resizeEvent(self, event):
        super().resizeEvent(event)
        self.update_elision()
        
    def update_elision(self):
        fm = self.fontMetrics()
        w = max(0, self.width() - 2)
        elided = fm.elidedText(self._full_text, Qt.TextElideMode.ElideRight, w)
        super().setText(elided)

    def mousePressEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton:
            self.clicked.emit()
        super().mousePressEvent(event)


class GalleryItemWidget(QWidget):
    """Individual container for an image, prompt, and metadata in the Gallery grid."""
    prompt_copied = pyqtSignal(str)
    favorite_toggled = pyqtSignal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setAttribute(Qt.WidgetAttribute.WA_StyledBackground, True)
        self.filepath = ""
        self.prompt = ""
        
        self.setStyleSheet("""
            GalleryItemWidget {
                background-color: #1e1e1e;
                border: 1px solid #333;
                border-radius: 4px;
            }
        """)
        
        # Force uniform sizing and prevent layout collapse when hidden
        policy = QSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        policy.setRetainSizeWhenHidden(True)
        self.setSizePolicy(policy)
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(4, 4, 4, 4)
        layout.setSpacing(4)
        
        self.image_display = ImageDisplay()
        self.image_display.setMinimumSize(32, 32)
        
        self.prompt_label = ElidedLabel()
        self.prompt_label.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.prompt_label.setStyleSheet("color: #ccc; font-size: 11px; border: none; background: transparent;")
        self.prompt_label.setToolTip("Click to copy prompt")
        
        self.meta_label = ElidedLabel()
        self.meta_label.setStyleSheet("color: #888; font-size: 10px; border: none; background: transparent;")
        
        layout.addWidget(self.image_display, stretch=1)
        layout.addWidget(self.prompt_label)
        layout.addWidget(self.meta_label)
        
        self.image_display.clicked.connect(self._on_image_clicked)
        self.image_display.right_clicked.connect(self._on_image_right_clicked)
        self.prompt_label.clicked.connect(self._on_prompt_clicked)
        
    def set_data(self, meta):
        self.filepath = meta.filepath
        self.prompt = meta.prompt
        self.image_display.set_image(meta.filepath)
        
        display_prompt = self.prompt.replace('\n', ' ').strip()
        if not display_prompt:
            display_prompt = "No prompt"
            
        self.prompt_label.setText(display_prompt)
        
        try:
            dt = datetime.strptime(meta.timestamp, "%Y-%m-%d_%H-%M-%S")
            ts_str = dt.strftime("%Y-%m-%d %H:%M:%S")
        except ValueError:
            ts_str = meta.timestamp
            
        self.meta_label.setText(f"{meta.service} | {meta.model} | {ts_str}")
        
        if getattr(meta, 'is_favorite', False):
            self.setStyleSheet("""
                GalleryItemWidget {
                    background-color: #1e1e1e;
                    border: 1px solid #FFD700;
                    border-radius: 4px;
                }
            """)
        else:
            self.setStyleSheet("""
                GalleryItemWidget {
                    background-color: #1e1e1e;
                    border: 1px solid #333;
                    border-radius: 4px;
                }
            """)
        self.show()
        
    def clear(self):
        self.filepath = ""
        self.prompt = ""
        self.image_display.clear_image()
        self.prompt_label.setText("")
        self.meta_label.setText("")
        self.setStyleSheet("""
            GalleryItemWidget {
                background-color: #1e1e1e;
                border: 1px solid #333;
                border-radius: 4px;
            }
        """)
        self.hide()
        
    def _on_image_clicked(self):
        if self.filepath:
            reveal_file_in_explorer(self.filepath)
            
    def _on_image_right_clicked(self):
        if self.filepath:
            self.favorite_toggled.emit(self.filepath)
            
    def _on_prompt_clicked(self):
        if self.prompt:
            from PyQt6.QtWidgets import QApplication
            QApplication.clipboard().setText(self.prompt)
            self.prompt_copied.emit("Prompt copied to clipboard.")


class GalleryPage(QWidget):
    """Media Gallery page displaying generated images in a paginated grid."""
    status_updated = pyqtSignal(str)
    
    FILTERS = ["All", "Pollinations", "Airforce", "Perchance"]
    ITEMS_PER_PAGE = 12

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.config_manager = config_manager
        self.service = GalleryService()
        
        self.images = []
        self.current_page = 1
        self.total_pages = 1
        self.current_filter = "All"
        self.favorites_only = False
        self.search_query = ""
        self._items = []
        
        self.active_dropdown = None
        self.hide_timer = QTimer()
        self.hide_timer.setInterval(250)
        self.hide_timer.timeout.connect(self._hide_dropdown)
        
        self._build_ui()
        self._load_from_config()
        self.refresh()

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # --- Controls Bar ---
        controls = QWidget()
        controls.setStyleSheet("background-color: #121212;")
        cl = QHBoxLayout(controls)
        cl.setContentsMargins(4, 4, 4, 4)
        cl.setSpacing(0)
        
        # Left Container
        left_container = QWidget()
        ll = QHBoxLayout(left_container)
        ll.setContentsMargins(0, 0, 0, 0)
        ll.setSpacing(6)
        
        self.filter_btn = QPushButton(self.current_filter)
        self.filter_btn.setStyleSheet(BTN_DROPDOWN)
        self.filter_btn.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Fixed)
        self.filter_btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.filter_dropdown = make_dropdown(self, self.FILTERS, self._on_filter_selected, self)
        self.filter_btn.installEventFilter(self)
        
        self.fav_btn = QPushButton("Favorites")
        self.fav_btn.setStyleSheet(BTN_DROPDOWN)
        self.fav_btn.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Fixed)
        self.fav_btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.fav_btn.clicked.connect(self._toggle_favorites)
        
        ll.addWidget(self.filter_btn, stretch=1)
        ll.addWidget(self.fav_btn, stretch=1)
        
        # Center Container
        center_container = QWidget()
        paginator_layout = QHBoxLayout(center_container)
        paginator_layout.setContentsMargins(0, 0, 0, 0)
        paginator_layout.setSpacing(2)
        
        self.first_btn = QPushButton("Â«")
        self.prev_btn = QPushButton("â€¹")
        self.next_btn = QPushButton("â€º")
        self.last_btn = QPushButton("Â»")
        
        for btn in [self.first_btn, self.prev_btn, self.next_btn, self.last_btn]:
            btn.setFixedSize(28, 28)
            btn.setStyleSheet(BTN_DROPDOWN)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            
        self.first_btn.clicked.connect(lambda: self.set_page(1))
        self.prev_btn.clicked.connect(lambda: self.set_page(self.current_page - 1))
        self.next_btn.clicked.connect(lambda: self.set_page(self.current_page + 1))
        self.last_btn.clicked.connect(self._goto_last_page)
        
        self.page_label = QLabel("Page 1 of 1 (0 items)")
        self.page_label.setStyleSheet("color: #ccc; font-size: 11px; padding: 0 8px;")
        self.page_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        paginator_layout.addWidget(self.first_btn)
        paginator_layout.addWidget(self.prev_btn)
        paginator_layout.addWidget(self.page_label)
        paginator_layout.addWidget(self.next_btn)
        paginator_layout.addWidget(self.last_btn)
        
        # Right Container
        right_container = QWidget()
        rl = QHBoxLayout(right_container)
        rl.setContentsMargins(0, 0, 0, 0)
        rl.setSpacing(6)
        
        from PyQt6.QtWidgets import QLineEdit
        from gui.widgets.image_gen_common import INPUT_STYLE
        self.search_input = QLineEdit()
        self.search_input.setPlaceholderText("Search prompts...")
        self.search_input.setStyleSheet(INPUT_STYLE)
        self.search_input.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Fixed)
        self.search_input.textChanged.connect(self._on_search_changed)
        
        rl.addWidget(self.search_input, stretch=1)
        
        cl.addWidget(left_container, stretch=1)
        cl.addWidget(center_container, stretch=0)
        cl.addWidget(right_container, stretch=1)
        
        layout.addWidget(controls)
        
        # --- Grid Area ---
        self.grid_container = QWidget()
        self.grid_container.setStyleSheet("background-color: #2a2a2a;")
        self.grid_layout = QGridLayout(self.grid_container)
        self.grid_layout.setContentsMargins(8, 8, 8, 8)
        self.grid_layout.setSpacing(8)
        
        for row in range(3):
            self.grid_layout.setRowStretch(row, 1)
            for col in range(4):
                if row == 0:
                    self.grid_layout.setColumnStretch(col, 1)
                item = GalleryItemWidget()
                item.prompt_copied.connect(self.status_updated.emit)
                item.favorite_toggled.connect(self._on_item_favorite_toggled)
                self.grid_layout.addWidget(item, row, col)
                self._items.append(item)
                
        layout.addWidget(self.grid_container, stretch=1)

    def eventFilter(self, obj, event):
        et = event.type()
        if et == QEvent.Type.Enter:
            if obj == self.filter_btn:
                self._show_dropdown(self.filter_dropdown, self.filter_btn)
            elif obj == self.filter_dropdown:
                self.hide_timer.stop()
        elif et == QEvent.Type.Leave:
            if obj in (self.filter_btn, self.filter_dropdown):
                self.hide_timer.start()
        return super().eventFilter(obj, event)

    def _show_dropdown(self, dropdown, button):
        self.hide_timer.stop()
        if self.active_dropdown and self.active_dropdown is not dropdown:
            self.active_dropdown.hide()
        if self.active_dropdown is dropdown:
            return
        self.active_dropdown = dropdown
        pos = button.mapToGlobal(button.rect().bottomLeft())
        dropdown.move(pos.x(), pos.y() + 2)
        dropdown.show()
        dropdown.raise_()

    def _hide_dropdown(self):
        if self.active_dropdown:
            self.active_dropdown.hide()
            self.active_dropdown = None

    def _on_filter_selected(self, filter_name: str):
        self.current_filter = filter_name
        self.filter_btn.setText(filter_name)
        self._hide_dropdown()
        self.current_page = 1
        self._save_to_config()
        self.refresh()
        
    def _save_to_config(self):
        if not self.config_manager:
            return
        self.config_manager.gallery_page = self.current_page
        self.config_manager.gallery_filter = self.current_filter
        self.config_manager.save()
        
    def _load_from_config(self):
        if not self.config_manager:
            return
        self.current_page = getattr(self.config_manager, "gallery_page", 1)
        self.current_filter = getattr(self.config_manager, "gallery_filter", "All")
        if self.current_filter in self.FILTERS:
            self.filter_btn.setText(self.current_filter)

    def _toggle_favorites(self):
        self.favorites_only = not self.favorites_only
        if self.favorites_only:
            self.fav_btn.setStyleSheet("""
                QPushButton {
                  background-color: #332A00; color: #FFD700;
                  border: 1px solid #FFD700; border-radius: 3px;
                  font-size: 12px; padding: 6px 8px;
                }
                QPushButton:hover { background-color: #4D4000; }
            """)
        else:
            self.fav_btn.setStyleSheet(BTN_DROPDOWN)
        self.current_page = 1
        self.refresh()

    def _on_search_changed(self, text):
        self.search_query = text
        self.current_page = 1
        self.refresh()
        
    def _on_item_favorite_toggled(self, filepath):
        self.service.toggle_favorite(filepath)
        self.refresh()

    def refresh(self):
        self.images = self.service.get_images(self.current_filter, self.favorites_only, self.search_query)
        self.total_pages = max(1, (len(self.images) + self.ITEMS_PER_PAGE - 1) // self.ITEMS_PER_PAGE)
        if self.current_page > self.total_pages:
            self.current_page = self.total_pages
        self._update_display()
        
    def _goto_last_page(self):
        self.set_page(self.total_pages)

    def set_page(self, page: int):
        if 1 <= page <= self.total_pages and page != self.current_page:
            self.current_page = page
            self._save_to_config()
            self._update_display()

    def _update_display(self):
        start_idx = (self.current_page - 1) * self.ITEMS_PER_PAGE
        end_idx = start_idx + self.ITEMS_PER_PAGE
        page_images = self.images[start_idx:end_idx]
        
        self.page_label.setText(f"Page {self.current_page} of {self.total_pages} ({len(self.images)} items)")
        
        self.first_btn.setEnabled(self.current_page > 1)
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        self.last_btn.setEnabled(self.current_page < self.total_pages)
        
        for i, item_widget in enumerate(self._items):
            if i < len(page_images):
                item_widget.set_data(page_images[i])
            else:
                item_widget.clear()

    def hideEvent(self, event):
        self._hide_dropdown()
        super().hideEvent(event)
```

```image_gen_common.py
# gui/widgets/image_gen_common.py
"""
Shared components for image generation pages.
Provides ImageDisplay widget, UI style constants, and dropdown factory.
"""

from PyQt6.QtWidgets import QLabel, QSizePolicy, QWidget, QVBoxLayout, QPushButton
from PyQt6.QtCore import pyqtSignal, Qt
from PyQt6.QtGui import QCursor, QPixmap


# â”€â”€ Shared style constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

INPUT_STYLE = (
    "QLineEdit {"
    "  background-color: #1e1e1e; color: #eee;"
    "  border: 1px solid #333; border-radius: 3px;"
    "  font-size: 12px; padding: 6px;"
    "}"
    "QLineEdit:disabled { color: #666; }"
)

BTN_GENERATE = (
    "QPushButton {"
    "  background-color: #1E88E5; color: #fff; font-weight: bold;"
    "  border: 1px solid #1E88E5; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 12px;"
    "}"
    "QPushButton:hover { background-color: #2A9BF8; border-color: #2A9BF8; }"
    "QPushButton:pressed { background-color: #1966C2; border-color: #1966C2; }"
)

BTN_CANCEL = (
    "QPushButton {"
    "  background-color: #F44336; color: #fff; font-weight: bold;"
    "  border: 1px solid #F44336; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 12px;"
    "}"
    "QPushButton:hover { background-color: #EF5350; border-color: #EF5350; }"
    "QPushButton:pressed { background-color: #D32F2F; border-color: #D32F2F; }"
)

BTN_DROPDOWN = (
    "QPushButton {"
    "  background-color: #1e1e1e; color: #eee;"
    "  border: 1px solid #333; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 8px;"
    "}"
    "QPushButton:hover { background-color: #2a2a2a; border-color: #555; }"
    "QPushButton:disabled { color: #666; }"
)

DROPDOWN_OPTION = (
    "QPushButton {"
    "  background-color: transparent; color: #eee; border: none;"
    "  text-align: left; padding: 6px 12px; font-size: 12px;"
    "}"
    "QPushButton:hover { background-color: #2a2a2a; }"
)

DROPDOWN_CONTAINER = (
    "QWidget { background-color: #1e1e1e; border: 1px solid #333; border-radius: 3px; }"
)


# â”€â”€ Shared widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class ImageDisplay(QLabel):
    """Custom label that displays an image fully contained, never cropped."""

    clicked = pyqtSignal()
    right_clicked = pyqtSignal()

    def __init__(self, parent=None):
        super().__init__(parent)
        self._pixmap = None
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self.setMinimumSize(64, 64)
        self.setStyleSheet("background-color: #121212; border: none;")

    def set_image(self, filepath: str):
        """Load and display an image from file path."""
        self._pixmap = QPixmap(filepath)
        self._update_display()
        self.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))

    def clear_image(self):
        self._pixmap = None
        self.clear()
        self.setCursor(QCursor(Qt.CursorShape.ArrowCursor))

    def mousePressEvent(self, event):
        if self._pixmap:
            if event.button() == Qt.MouseButton.LeftButton:
                self.clicked.emit()
            elif event.button() == Qt.MouseButton.RightButton:
                self.right_clicked.emit()
        super().mousePressEvent(event)

    def _update_display(self):
        if self._pixmap and not self._pixmap.isNull():
            scaled = self._pixmap.scaled(
                self.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation,
            )
            self.setPixmap(scaled)

    def resizeEvent(self, event):
        super().resizeEvent(event)
        self._update_display()


# â”€â”€ Shared helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def make_dropdown(parent_widget, options: list, callback, event_filter_obj) -> QWidget:
    """Create a hover-activated dropdown widget with the given options.

    Args:
        parent_widget:    Widget whose window() is used as the dropdown parent.
        options:          List of string labels for the dropdown items.
        callback:         Called with the selected option string on click.
        event_filter_obj: QObject that will receive Enter/Leave events on the dropdown.
    """
    dd = QWidget(parent_widget.window() or None)
    dd.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Tool)
    dd.setAttribute(Qt.WidgetAttribute.WA_ShowWithoutActivating)
    dd.setStyleSheet(DROPDOWN_CONTAINER)
    lo = QVBoxLayout(dd)
    lo.setContentsMargins(2, 2, 2, 2)
    lo.setSpacing(1)

    for opt in options:
        btn = QPushButton(opt)
        btn.setStyleSheet(DROPDOWN_OPTION)
        btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        btn.clicked.connect(lambda _, o=opt: callback(o))
        lo.addWidget(btn)

    dd.adjustSize()
    dd.hide()
    dd.installEventFilter(event_filter_obj)
    return dd
```

```media_panel.py
# gui/widgets/media_panel.py
"""
Media Panel - Secondary pane for generative imaging interfacing.
Provides tabbed navigation for different image generation APIs.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton,
    QStackedWidget, QLabel, QSizePolicy, QApplication,
    QLineEdit, QTextEdit, QPlainTextEdit
)
from PyQt6.QtCore import Qt, pyqtSignal, QObject, QEvent
from PyQt6.QtGui import QCursor
from gui.widgets.pollinations_page import PollinationsPage
from gui.widgets.airforce_page import AirforcePage
from gui.widgets.perchance_page import PerchancePage


class MediaPanelHotkeysFilter(QObject):
    def __init__(self, panel):
        super().__init__(panel)
        self.panel = panel
        
    def eventFilter(self, obj, event):
        if event.type() == QEvent.Type.KeyPress:
            if event.key() in (Qt.Key.Key_Left, Qt.Key.Key_Right):
                focused = QApplication.focusWidget()
                if isinstance(focused, (QLineEdit, QTextEdit, QPlainTextEdit)):
                    return False
                if self.panel.rect().contains(self.panel.mapFromGlobal(QCursor.pos())):
                    stack = self.panel._stack
                    current = stack.currentWidget()
                    if current and hasattr(current, "set_page") and hasattr(current, "current_page"):
                        delta = -1 if event.key() == Qt.Key.Key_Left else 1
                        current.set_page(current.current_page + delta)
                        return True
        elif event.type() == QEvent.Type.Wheel:
            if self.panel.rect().contains(self.panel.mapFromGlobal(QCursor.pos())):
                stack = self.panel._stack
                current = stack.currentWidget()
                if current and hasattr(current, "set_page") and hasattr(current, "current_page"):
                    delta = -1 if event.angleDelta().y() > 0 else 1
                    current.set_page(current.current_page + delta)
                    return True
        elif event.type() == QEvent.Type.MouseButtonPress:
            focused = QApplication.focusWidget()
            if isinstance(focused, (QLineEdit, QTextEdit, QPlainTextEdit)):
                if self.panel.rect().contains(self.panel.mapFromGlobal(QCursor.pos())):
                    widget_clicked = QApplication.widgetAt(QCursor.pos())
                    if not isinstance(widget_clicked, (QLineEdit, QTextEdit, QPlainTextEdit)):
                        focused.clearFocus()
        return False


class MediaPanel(QWidget):
    """Secondary pane with tabbed navigation for image generation API interfaces."""

    status_updated = pyqtSignal(str)

    TAB_NAMES = ["Gallery", "Pollinations", "Airforce", "Perchance"]

    ACTIVE_BG = "#1E88E5"
    ACTIVE_HOVER = "#2A9BF8"
    INACTIVE_BG = "#2a2a2a"
    INACTIVE_HOVER = "#3d3d3d"

    _TAB_ICONS = {"Gallery": "ðŸ–¼ï¸", "Pollinations": "ðŸŒ¸", "Airforce": "âœˆï¸", "Perchance": "ðŸŽ²"}
    _TAB_DESCS = {
        "Gallery": "Generated images will appear here",
        "Pollinations": "Pollinations AI image generation",
        "Airforce": "Airforce image generation API",
        "Perchance": "Perchance image generation",
    }

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.setObjectName("MediaPanel")
        self.config_manager = config_manager
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self._current_tab = 0
        self._tabs = []
        self._build_ui()
        self._load_active_tab()
        
        self.hotkeys_filter = MediaPanelHotkeysFilter(self)
        QApplication.instance().installEventFilter(self.hotkeys_filter)

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # --- Tab bar ---
        tab_bar = QWidget()
        tab_bar.setFixedHeight(34)
        tab_bar.setStyleSheet("background-color: #1a1a1a;")
        tab_layout = QHBoxLayout(tab_bar)
        tab_layout.setContentsMargins(0, 0, 0, 0)
        tab_layout.setSpacing(1)

        for i, name in enumerate(self.TAB_NAMES):
            btn = QPushButton(name)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            btn.setFocusPolicy(Qt.FocusPolicy.NoFocus)
            btn.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
            btn.clicked.connect(lambda _, idx=i: self._switch_tab(idx))
            self._tabs.append(btn)
            tab_layout.addWidget(btn)

        layout.addWidget(tab_bar)

        # --- Stacked content area ---
        self._stack = QStackedWidget()
        self._stack.setStyleSheet("background-color: #2a2a2a; border: 1px solid #333;")

        from gui.widgets.gallery_page import GalleryPage
        for name in self.TAB_NAMES:
            if name == "Gallery":
                self.gallery_page = GalleryPage(self.config_manager)
                self.gallery_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.gallery_page)
            elif name == "Pollinations":
                self.pollinations_page = PollinationsPage(self.config_manager)
                self.pollinations_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.pollinations_page)
            elif name == "Airforce":
                self.airforce_page = AirforcePage(self.config_manager)
                self.airforce_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.airforce_page)
            elif name == "Perchance":
                self.perchance_page = PerchancePage(self.config_manager)
                self.perchance_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.perchance_page)
            else:
                self._stack.addWidget(self._create_page(name))

        layout.addWidget(self._stack, 1)
        self._update_tab_styles()

    def _create_page(self, name: str) -> QWidget:
        """Create a placeholder page for a tab."""
        page = QWidget()
        page_layout = QVBoxLayout(page)
        page_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        icon = QLabel(self._TAB_ICONS.get(name, "ðŸ“„"))
        icon.setStyleSheet("font-size: 32pt;")
        icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(icon)

        title = QLabel(name)
        title.setStyleSheet("color: #666; font-size: 14pt; font-weight: bold;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(title)

        desc = QLabel(self._TAB_DESCS.get(name, ""))
        desc.setStyleSheet("color: #444; font-size: 9pt;")
        desc.setAlignment(Qt.AlignmentFlag.AlignCenter)
        desc.setWordWrap(True)
        page_layout.addWidget(desc)

        return page

    def _switch_tab(self, index: int):
        """Switch to the specified tab index."""
        if index == self._current_tab:
            return
        self._current_tab = index
        self._stack.setCurrentIndex(index)
        self._update_tab_styles()
        
        current_widget = self._stack.widget(index)
        if hasattr(current_widget, "refresh"):
            current_widget.refresh()
            
        if self.config_manager:
            self.config_manager.media_active_tab = index
            self.config_manager.save()

    def _load_active_tab(self):
        """Restore the last active tab from config."""
        if self.config_manager:
            tab = getattr(self.config_manager, 'media_active_tab', 0)
            if 0 <= tab < len(self.TAB_NAMES):
                self._current_tab = tab
                self._stack.setCurrentIndex(tab)
                self._update_tab_styles()

    def _update_tab_styles(self):
        """Update tab button visual styles based on active selection."""
        for i, btn in enumerate(self._tabs):
            if i == self._current_tab:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.ACTIVE_BG};
                        color: #ffffff;
                        font-weight: bold;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.ACTIVE_HOVER};
                    }}
                """)
            else:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.INACTIVE_BG};
                        color: #888;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.INACTIVE_HOVER};
                        color: #fff;
                    }}
                """)

```

### CONTEXT

## ðŸŽ¯ Focused Context (Agent-Selected)

**Project Root:** `image-prompter/`
**Files Included:** 7

---

### File Index

1. `gui/widgets/gallery_page.py`
2. `core/services/gallery_service.py`
3. `gui/widgets/media_panel.py`
4. `gui/main_window.py`
5. `gui/widgets/image_gen_common.py`
6. `core/config.py`
7. `core/utils.py`

---

### `gui/widgets/gallery_page.py`

```python
# gui/widgets/gallery_page.py
"""
Gallery Page - Displays generated images in a responsive 4x3 grid.
Includes pagination, filtering, and prompt copying functionalities.
"""

from datetime import datetime

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, QGridLayout, QSizePolicy
)
from PyQt6.QtCore import pyqtSignal, Qt, QTimer, QEvent
from PyQt6.QtGui import QCursor

from gui.widgets.image_gen_common import ImageDisplay, BTN_DROPDOWN, make_dropdown
from core.utils import reveal_file_in_explorer
from core.services.gallery_service import GalleryService


class ElidedLabel(QLabel):
    """A QLabel that elides its text on the right if it exceeds widget width."""
    clicked = pyqtSignal()
    
    def __init__(self, text="", parent=None):
        super().__init__(text, parent)
        self._full_text = text
        self.setSizePolicy(QSizePolicy.Policy.Ignored, QSizePolicy.Policy.Fixed)
        
    def setText(self, text):
        self._full_text = text
        super().setText(text)
        self.update_elision()
        
    def resizeEvent(self, event):
        super().resizeEvent(event)
        self.update_elision()
        
    def update_elision(self):
        fm = self.fontMetrics()
        w = max(0, self.width() - 2)
        elided = fm.elidedText(self._full_text, Qt.TextElideMode.ElideRight, w)
        super().setText(elided)

    def mousePressEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton:
            self.clicked.emit()
        super().mousePressEvent(event)


class GalleryItemWidget(QWidget):
    """Individual container for an image, prompt, and metadata in the Gallery grid."""
    prompt_copied = pyqtSignal(str)
    
    def __init__(self, parent=None):
        super().__init__(parent)
        self.filepath = ""
        self.prompt = ""
        
        self.setStyleSheet("""
            GalleryItemWidget {
                background-color: #1e1e1e;
                border: 1px solid #333;
                border-radius: 4px;
            }
        """)
        
        # Force uniform sizing and prevent layout collapse when hidden
        policy = QSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        policy.setRetainSizeWhenHidden(True)
        self.setSizePolicy(policy)
        
        layout = QVBoxLayout(self)
        layout.setContentsMargins(4, 4, 4, 4)
        layout.setSpacing(4)
        
        self.image_display = ImageDisplay()
        self.image_display.setMinimumSize(32, 32)
        
        self.prompt_label = ElidedLabel()
        self.prompt_label.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.prompt_label.setStyleSheet("color: #ccc; font-size: 11px; border: none; background: transparent;")
        self.prompt_label.setToolTip("Click to copy prompt")
        
        self.meta_label = ElidedLabel()
        self.meta_label.setStyleSheet("color: #888; font-size: 10px; border: none; background: transparent;")
        
        layout.addWidget(self.image_display, stretch=1)
        layout.addWidget(self.prompt_label)
        layout.addWidget(self.meta_label)
        
        self.image_display.clicked.connect(self._on_image_clicked)
        self.prompt_label.clicked.connect(self._on_prompt_clicked)
        
    def set_data(self, meta):
        self.filepath = meta.filepath
        self.prompt = meta.prompt
        self.image_display.set_image(meta.filepath)
        
        display_prompt = self.prompt.replace('\n', ' ').strip()
        if not display_prompt:
            display_prompt = "No prompt"
            
        self.prompt_label.setText(display_prompt)
        
        try:
            dt = datetime.strptime(meta.timestamp, "%Y-%m-%d_%H-%M-%S")
            ts_str = dt.strftime("%Y-%m-%d %H:%M:%S")
        except ValueError:
            ts_str = meta.timestamp
            
        self.meta_label.setText(f"{meta.service} | {meta.model} | {ts_str}")
        self.show()
        
    def clear(self):
        self.filepath = ""
        self.prompt = ""
        self.image_display.clear_image()
        self.prompt_label.setText("")
        self.meta_label.setText("")
        self.hide()
        
    def _on_image_clicked(self):
        if self.filepath:
            reveal_file_in_explorer(self.filepath)
            
    def _on_prompt_clicked(self):
        if self.prompt:
            from PyQt6.QtWidgets import QApplication
            QApplication.clipboard().setText(self.prompt)
            self.prompt_copied.emit("Prompt copied to clipboard.")


class GalleryPage(QWidget):
    """Media Gallery page displaying generated images in a paginated grid."""
    status_updated = pyqtSignal(str)
    
    FILTERS = ["All", "Pollinations", "Airforce", "Perchance"]
    ITEMS_PER_PAGE = 12

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.config_manager = config_manager
        self.service = GalleryService()
        
        self.images = []
        self.current_page = 1
        self.total_pages = 1
        self.current_filter = "All"
        self._items = []
        
        self.active_dropdown = None
        self.hide_timer = QTimer()
        self.hide_timer.setInterval(250)
        self.hide_timer.timeout.connect(self._hide_dropdown)
        
        self._build_ui()
        self._load_from_config()
        self.refresh()

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)
        
        # --- Controls Bar ---
        controls = QWidget()
        controls.setStyleSheet("background-color: #121212;")
        cl = QHBoxLayout(controls)
        cl.setContentsMargins(4, 4, 4, 4)
        cl.setSpacing(6)
        
        cl.addStretch(1)
        
        # Internal Page Pagination
        paginator_layout = QHBoxLayout()
        paginator_layout.setSpacing(2)
        
        self.first_btn = QPushButton("Â«")
        self.prev_btn = QPushButton("â€¹")
        self.next_btn = QPushButton("â€º")
        self.last_btn = QPushButton("Â»")
        
        for btn in [self.first_btn, self.prev_btn, self.next_btn, self.last_btn]:
            btn.setFixedSize(28, 28)
            btn.setStyleSheet(BTN_DROPDOWN)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            paginator_layout.addWidget(btn)
            
        self.first_btn.clicked.connect(lambda: self.set_page(1))
        self.prev_btn.clicked.connect(lambda: self.set_page(self.current_page - 1))
        self.next_btn.clicked.connect(lambda: self.set_page(self.current_page + 1))
        self.last_btn.clicked.connect(self._goto_last_page)
        
        self.page_label = QLabel("Page 1 of 1 (0 items)")
        self.page_label.setStyleSheet("color: #ccc; font-size: 11px; padding: 0 8px;")
        self.page_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        
        paginator_layout.insertWidget(2, self.page_label)
        cl.addLayout(paginator_layout)
        
        cl.addStretch(1)
        
        # Display Filtering Toggles
        self.filter_btn = QPushButton(self.current_filter)
        self.filter_btn.setStyleSheet(BTN_DROPDOWN)
        self.filter_btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        self.filter_btn.setMinimumWidth(100)
        
        self.filter_dropdown = make_dropdown(self, self.FILTERS, self._on_filter_selected, self)
        self.filter_btn.installEventFilter(self)
        
        cl.addWidget(self.filter_btn)
        layout.addWidget(controls)
        
        # --- Grid Area ---
        self.grid_container = QWidget()
        self.grid_container.setStyleSheet("background-color: #2a2a2a;")
        self.grid_layout = QGridLayout(self.grid_container)
        self.grid_layout.setContentsMargins(8, 8, 8, 8)
        self.grid_layout.setSpacing(8)
        
        for row in range(3):
            self.grid_layout.setRowStretch(row, 1)
            for col in range(4):
                if row == 0:
                    self.grid_layout.setColumnStretch(col, 1)
                item = GalleryItemWidget()
                item.prompt_copied.connect(self.status_updated.emit)
                self.grid_layout.addWidget(item, row, col)
                self._items.append(item)
                
        layout.addWidget(self.grid_container, stretch=1)

    def eventFilter(self, obj, event):
        et = event.type()
        if et == QEvent.Type.Enter:
            if obj == self.filter_btn:
                self._show_dropdown(self.filter_dropdown, self.filter_btn)
            elif obj == self.filter_dropdown:
                self.hide_timer.stop()
        elif et == QEvent.Type.Leave:
            if obj in (self.filter_btn, self.filter_dropdown):
                self.hide_timer.start()
        return super().eventFilter(obj, event)

    def _show_dropdown(self, dropdown, button):
        self.hide_timer.stop()
        if self.active_dropdown and self.active_dropdown is not dropdown:
            self.active_dropdown.hide()
        if self.active_dropdown is dropdown:
            return
        self.active_dropdown = dropdown
        pos = button.mapToGlobal(button.rect().bottomLeft())
        dropdown.move(pos.x(), pos.y() + 2)
        dropdown.show()
        dropdown.raise_()

    def _hide_dropdown(self):
        if self.active_dropdown:
            self.active_dropdown.hide()
            self.active_dropdown = None

    def _on_filter_selected(self, filter_name: str):
        self.current_filter = filter_name
        self.filter_btn.setText(filter_name)
        self._hide_dropdown()
        self.current_page = 1
        self._save_to_config()
        self.refresh()
        
    def _save_to_config(self):
        if not self.config_manager:
            return
        self.config_manager.gallery_page = self.current_page
        self.config_manager.gallery_filter = self.current_filter
        self.config_manager.save()
        
    def _load_from_config(self):
        if not self.config_manager:
            return
        self.current_page = getattr(self.config_manager, "gallery_page", 1)
        self.current_filter = getattr(self.config_manager, "gallery_filter", "All")
        if self.current_filter in self.FILTERS:
            self.filter_btn.setText(self.current_filter)

    def refresh(self):
        self.images = self.service.get_images(self.current_filter)
        self.total_pages = max(1, (len(self.images) + self.ITEMS_PER_PAGE - 1) // self.ITEMS_PER_PAGE)
        if self.current_page > self.total_pages:
            self.current_page = self.total_pages
        self._update_display()
        
    def _goto_last_page(self):
        self.set_page(self.total_pages)

    def set_page(self, page: int):
        if 1 <= page <= self.total_pages and page != self.current_page:
            self.current_page = page
            self._save_to_config()
            self._update_display()

    def _update_display(self):
        start_idx = (self.current_page - 1) * self.ITEMS_PER_PAGE
        end_idx = start_idx + self.ITEMS_PER_PAGE
        page_images = self.images[start_idx:end_idx]
        
        self.page_label.setText(f"Page {self.current_page} of {self.total_pages} ({len(self.images)} items)")
        
        self.first_btn.setEnabled(self.current_page > 1)
        self.prev_btn.setEnabled(self.current_page > 1)
        self.next_btn.setEnabled(self.current_page < self.total_pages)
        self.last_btn.setEnabled(self.current_page < self.total_pages)
        
        for i, item_widget in enumerate(self._items):
            if i < len(page_images):
                item_widget.set_data(page_images[i])
            else:
                item_widget.clear()

    def hideEvent(self, event):
        self._hide_dropdown()
        super().hideEvent(event)
```

### `core/services/gallery_service.py`

```python
# core/services/gallery_service.py
"""
Gallery Service - Reads and caches image metadata from the generated images directory.
"""

from pathlib import Path
from dataclasses import dataclass
from typing import List, Dict

@dataclass
class ImageMetadata:
    filepath: str
    prompt: str
    service: str
    model: str
    timestamp: str
    negative_prompt: str = ""
    size: str = ""
    seed: str = ""
    guidance_scale: str = ""


class GalleryService:
    def __init__(self):
        self._cache: Dict[str, tuple[float, ImageMetadata]] = {}
        self.images_dir = Path("images")
        self.images_dir.mkdir(exist_ok=True)
        
    def get_images(self, filter_service: str = "All") -> List[ImageMetadata]:
        images = []
        if not self.images_dir.exists():
            return images
            
        for p in self.images_dir.glob("*.jpg"):
            try:
                mtime = p.stat().st_mtime
                filepath_str = str(p)
                
                # Check cache mapping via modified time
                if filepath_str in self._cache and self._cache[filepath_str][0] == mtime:
                    meta = self._cache[filepath_str][1]
                else:
                    meta = self._parse_metadata(p)
                    self._cache[filepath_str] = (mtime, meta)
                    
                if filter_service == "All" or meta.service.lower() == filter_service.lower():
                    images.append(meta)
            except Exception:
                continue
                
        # Sort by filepath descending (newest timestamp first)
        images.sort(key=lambda x: x.filepath, reverse=True)
        return images
        
    def _parse_metadata(self, filepath: Path) -> ImageMetadata:
        prompt = ""
        service = "Unknown"
        model = "Unknown"
        timestamp = filepath.stem
        negative_prompt = ""
        size = ""
        seed = ""
        guidance_scale = ""

        try:
            from PIL import Image
            with Image.open(filepath) as img:
                exif = img.getexif()
                if exif and 0x010E in exif:
                    meta_str = exif[0x010E]
                    parts = [p.strip() for p in meta_str.split("|")]
                    for part in parts:
                        if part.startswith("Prompt:"):
                            prompt = part[7:].strip()
                        elif part.startswith("Service:"):
                            service = part[8:].strip()
                        elif part.startswith("Model:"):
                            model = part[6:].strip()
                        elif part.startswith("Negative:"):
                            negative_prompt = part[9:].strip()
                        elif part.startswith("Size:"):
                            size = part[5:].strip()
                        elif part.startswith("Seed:"):
                            seed = part[5:].strip()
                        elif part.startswith("GuidanceScale:"):
                            guidance_scale = part[14:].strip()
        except Exception:
            pass

        return ImageMetadata(
            str(filepath), prompt, service, model, timestamp,
            negative_prompt, size, seed, guidance_scale,
        )
```

### `gui/widgets/media_panel.py`

```python
# gui/widgets/media_panel.py
"""
Media Panel - Secondary pane for generative imaging interfacing.
Provides tabbed navigation for different image generation APIs.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton,
    QStackedWidget, QLabel, QSizePolicy
)
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtGui import QCursor
from gui.widgets.pollinations_page import PollinationsPage
from gui.widgets.airforce_page import AirforcePage
from gui.widgets.perchance_page import PerchancePage


class MediaPanel(QWidget):
    """Secondary pane with tabbed navigation for image generation API interfaces."""

    status_updated = pyqtSignal(str)

    TAB_NAMES = ["Gallery", "Pollinations", "Airforce", "Perchance"]

    ACTIVE_BG = "#1E88E5"
    ACTIVE_HOVER = "#2A9BF8"
    INACTIVE_BG = "#2a2a2a"
    INACTIVE_HOVER = "#3d3d3d"

    _TAB_ICONS = {"Gallery": "ðŸ–¼ï¸", "Pollinations": "ðŸŒ¸", "Airforce": "âœˆï¸", "Perchance": "ðŸŽ²"}
    _TAB_DESCS = {
        "Gallery": "Generated images will appear here",
        "Pollinations": "Pollinations AI image generation",
        "Airforce": "Airforce image generation API",
        "Perchance": "Perchance image generation",
    }

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.config_manager = config_manager
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self._current_tab = 0
        self._tabs = []
        self._build_ui()
        self._load_active_tab()

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # --- Tab bar ---
        tab_bar = QWidget()
        tab_bar.setFixedHeight(34)
        tab_bar.setStyleSheet("background-color: #1a1a1a;")
        tab_layout = QHBoxLayout(tab_bar)
        tab_layout.setContentsMargins(0, 0, 0, 0)
        tab_layout.setSpacing(1)

        for i, name in enumerate(self.TAB_NAMES):
            btn = QPushButton(name)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            btn.setFocusPolicy(Qt.FocusPolicy.NoFocus)
            btn.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
            btn.clicked.connect(lambda _, idx=i: self._switch_tab(idx))
            self._tabs.append(btn)
            tab_layout.addWidget(btn)

        layout.addWidget(tab_bar)

        # --- Stacked content area ---
        self._stack = QStackedWidget()
        self._stack.setStyleSheet("background-color: #2a2a2a; border: 1px solid #333;")

        from gui.widgets.gallery_page import GalleryPage
        for name in self.TAB_NAMES:
            if name == "Gallery":
                self.gallery_page = GalleryPage(self.config_manager)
                self.gallery_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.gallery_page)
            elif name == "Pollinations":
                self.pollinations_page = PollinationsPage(self.config_manager)
                self.pollinations_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.pollinations_page)
            elif name == "Airforce":
                self.airforce_page = AirforcePage(self.config_manager)
                self.airforce_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.airforce_page)
            elif name == "Perchance":
                self.perchance_page = PerchancePage(self.config_manager)
                self.perchance_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.perchance_page)
            else:
                self._stack.addWidget(self._create_page(name))

        layout.addWidget(self._stack, 1)
        self._update_tab_styles()

    def _create_page(self, name: str) -> QWidget:
        """Create a placeholder page for a tab."""
        page = QWidget()
        page_layout = QVBoxLayout(page)
        page_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        icon = QLabel(self._TAB_ICONS.get(name, "ðŸ“„"))
        icon.setStyleSheet("font-size: 32pt;")
        icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(icon)

        title = QLabel(name)
        title.setStyleSheet("color: #666; font-size: 14pt; font-weight: bold;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(title)

        desc = QLabel(self._TAB_DESCS.get(name, ""))
        desc.setStyleSheet("color: #444; font-size: 9pt;")
        desc.setAlignment(Qt.AlignmentFlag.AlignCenter)
        desc.setWordWrap(True)
        page_layout.addWidget(desc)

        return page

    def _switch_tab(self, index: int):
        """Switch to the specified tab index."""
        if index == self._current_tab:
            return
        self._current_tab = index
        self._stack.setCurrentIndex(index)
        self._update_tab_styles()
        
        current_widget = self._stack.widget(index)
        if hasattr(current_widget, "refresh"):
            current_widget.refresh()
            
        if self.config_manager:
            self.config_manager.media_active_tab = index
            self.config_manager.save()

    def _load_active_tab(self):
        """Restore the last active tab from config."""
        if self.config_manager:
            tab = getattr(self.config_manager, 'media_active_tab', 0)
            if 0 <= tab < len(self.TAB_NAMES):
                self._current_tab = tab
                self._stack.setCurrentIndex(tab)
                self._update_tab_styles()

    def _update_tab_styles(self):
        """Update tab button visual styles based on active selection."""
        for i, btn in enumerate(self._tabs):
            if i == self._current_tab:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.ACTIVE_BG};
                        color: #ffffff;
                        font-weight: bold;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.ACTIVE_HOVER};
                    }}
                """)
            else:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.INACTIVE_BG};
                        color: #888;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.INACTIVE_HOVER};
                        color: #fff;
                    }}
                """)
```

### `gui/main_window.py`

```python
# gui/main_window.py
"""
Main Window GUI - Constructs the main application window with a split-pane layout.
Primary chat pane (left) with scoped footer, secondary media pane (right) with tabs.
"""
from PyQt6.QtWidgets import QApplication, QMainWindow, QWidget, QVBoxLayout, QLabel, QSplitter
from PyQt6.QtCore import pyqtSignal, Qt
from PyQt6.QtGui import QIcon, QShortcut, QKeySequence
from gui.widgets.action_buttons_panel import ActionButtonsPanel
from gui.widgets.input_panel import InputPanel
from gui.widgets.response_panel import ResponsePanel
from gui.widgets.media_panel import MediaPanel


class MainWindow(QMainWindow):
    """Main application window with asymmetrical split-pane layout."""

    status_signal = pyqtSignal(str)

    def __init__(self, file_service, config_manager=None):
        super().__init__()
        self.file_service = file_service
        self.config_manager = config_manager
        self.file_service.files_updated.connect(self._on_files_updated)
        self.file_service.status_updated.connect(self.status_signal.emit)
        self.file_service.files_cleared.connect(self._on_files_cleared)
        self.setWindowTitle("PyQt6 Chat Framework")
        self.setWindowIcon(QIcon("assets/icons/app_icon.ico"))
        self.setStyleSheet("""
            QMainWindow, QStatusBar { background-color: #1a1a1a; }
            QLabel { color: #ffffff; font-family: Arial; }
            QPushButton { background-color: #3d3d3d; color: #ffffff; border: 1px solid #333; padding: 8px; font-family: Arial; font-size: 9pt; border-radius: 4px; }
            QPushButton:hover { background-color: #4d4d4d; }
            QPushButton:pressed { background-color: #2d2d2d; }
            QTextEdit { background-color: #1e1e1e; color: #ffffff; border: 1px solid #333; font-family: Consolas; font-size: 9pt; }
            QStatusBar { color: #888888; font-size: 8pt; }
            QSplitter::handle {
                background-color: #333333;
            }
            QSplitter::handle:hover {
                background-color: #4d4d4d;
            }
            QSplitter::handle:pressed {
                background-color: #1E88E5;
            }
        """)

        central = QWidget()
        self.setCentralWidget(central)
        main_layout = QVBoxLayout(central)
        main_layout.setContentsMargins(10, 10, 10, 5)
        main_layout.setSpacing(5)

        # --- Horizontal splitter: chat pane | media pane ---
        self.splitter = QSplitter(Qt.Orientation.Horizontal)
        self.splitter.setHandleWidth(5)
        self.splitter.setChildrenCollapsible(False)

        # Left pane: Chat (response + input + action buttons)
        chat_pane = QWidget()
        chat_pane.setMinimumWidth(400)
        chat_pane_layout = QVBoxLayout(chat_pane)
        chat_pane_layout.setContentsMargins(0, 0, 0, 0)
        chat_pane_layout.setSpacing(10)
        self._build_chat_pane(chat_pane_layout)
        self.splitter.addWidget(chat_pane)

        # Right pane: Media (tabbed image generation interface)
        self.media_panel = MediaPanel(self.config_manager)
        self.media_panel.setMinimumWidth(280)
        self.splitter.addWidget(self.media_panel)

        # Default asymmetric split ~65/35, stretch ratio 3:2
        self.splitter.setSizes([780, 420])
        self.splitter.setStretchFactor(0, 3)
        self.splitter.setStretchFactor(1, 2)

        main_layout.addWidget(self.splitter, 1)

        # --- Status bar ---
        self.status_label = QLabel("Ready")
        self.status_label.setStyleSheet("color: #888; font-size: 8pt;")
        self.status_signal.connect(self.status_label.setText)
        main_layout.addWidget(self.status_label, 0, Qt.AlignmentFlag.AlignLeft)

        self.status_signal.emit("Ready")
        self._setup_shortcuts()

    def _setup_shortcuts(self):
        """Set up global keyboard shortcuts."""
        search_shortcut = QShortcut(QKeySequence.StandardKey.Find, self)
        search_shortcut.activated.connect(self.response_panel.show_search)

        nav_left_shortcut = QShortcut(QKeySequence("Ctrl+Left"), self)
        nav_left_shortcut.activated.connect(lambda: self.action_buttons_panel.navigate_left_signal.emit())

        nav_right_shortcut = QShortcut(QKeySequence("Ctrl+Right"), self)
        nav_right_shortcut.activated.connect(lambda: self.action_buttons_panel.navigate_right_signal.emit())

        delete_all_shortcut = QShortcut(QKeySequence("Ctrl+D"), self)
        delete_all_shortcut.activated.connect(lambda: self.action_buttons_panel.delete_all_chats_signal.emit())

    def _build_chat_pane(self, layout):
        """Build the primary chat pane with response, input, and action buttons."""
        self.main_panel_layout = layout

        # Response panel (takes all available vertical space)
        self.response_panel = ResponsePanel()
        layout.addWidget(self.response_panel)

        # Input panel (scoped footer - dynamic height)
        self.input_panel = InputPanel()
        layout.addWidget(self.input_panel)

        # Action buttons panel (scoped footer - fixed height)
        self.action_buttons_panel = ActionButtonsPanel(self.file_service)
        layout.addWidget(self.action_buttons_panel)

        self.input_panel.text_content_changed_signal.connect(self.action_buttons_panel.update_text_action_buttons)

        layout.setStretchFactor(self.response_panel, 1)
        layout.setStretchFactor(self.input_panel, 0)
        layout.setStretchFactor(self.action_buttons_panel, 0)

    def _on_files_cleared(self):
        self.action_buttons_panel.select_file_signal.emit("", "")

    def _on_files_updated(self, filenames):
        """Handle files updated signal - update status bar with file list."""
        if not filenames:
            self.status_signal.emit("No files selected.")
            return
        if len(filenames) == 1:
            self.status_signal.emit(f"File ready: {filenames[0]}")
        elif len(filenames) <= 3:
            self.status_signal.emit(f"Files ready: {', '.join(filenames)}")
        else:
            self.status_signal.emit(f"Files ready: {', '.join(filenames[:3])}... ({len(filenames)} total)")

    def keyPressEvent(self, event):
        """Handle keyboard events - Ctrl+V for clipboard paste."""
        modifiers = event.modifiers()
        if (modifiers & Qt.KeyboardModifier.ControlModifier) and event.key() == Qt.Key.Key_V:
            clipboard = QApplication.clipboard()
            mime_data = clipboard.mimeData()
            if mime_data.hasImage():
                img = clipboard.image()
                if not img.isNull():
                    from PyQt6.QtCore import QBuffer, QIODevice
                    buf = QBuffer()
                    buf.open(QIODevice.OpenModeFlag.WriteOnly)
                    img.save(buf, "PNG")
                    self.file_service.load_file_from_data(bytes(buf.data()), "clipboard.png")
                    return
        super().keyPressEvent(event)

    def get_input_text(self) -> str:
        """Get the text from the input text edit."""
        return self.input_panel.get_input_text()

    def closeEvent(self, event):
        """Handle window close event to save window size and splitter state."""
        if getattr(self, 'config_manager', None):
            self.config_manager.window_width = self.width()
            self.config_manager.window_height = self.height()
            self.config_manager.splitter_sizes = self.splitter.sizes()
            self.config_manager.save()
        event.accept()
```

### `gui/widgets/image_gen_common.py`

```python
# gui/widgets/image_gen_common.py
"""
Shared components for image generation pages.
Provides ImageDisplay widget, UI style constants, and dropdown factory.
"""

from PyQt6.QtWidgets import QLabel, QSizePolicy, QWidget, QVBoxLayout, QPushButton
from PyQt6.QtCore import pyqtSignal, Qt
from PyQt6.QtGui import QCursor, QPixmap


# â”€â”€ Shared style constants â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

INPUT_STYLE = (
    "QLineEdit {"
    "  background-color: #1e1e1e; color: #eee;"
    "  border: 1px solid #333; border-radius: 3px;"
    "  font-size: 12px; padding: 6px;"
    "}"
    "QLineEdit:disabled { color: #666; }"
)

BTN_GENERATE = (
    "QPushButton {"
    "  background-color: #1E88E5; color: #fff; font-weight: bold;"
    "  border: 1px solid #1E88E5; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 12px;"
    "}"
    "QPushButton:hover { background-color: #2A9BF8; border-color: #2A9BF8; }"
    "QPushButton:pressed { background-color: #1966C2; border-color: #1966C2; }"
)

BTN_CANCEL = (
    "QPushButton {"
    "  background-color: #F44336; color: #fff; font-weight: bold;"
    "  border: 1px solid #F44336; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 12px;"
    "}"
    "QPushButton:hover { background-color: #EF5350; border-color: #EF5350; }"
    "QPushButton:pressed { background-color: #D32F2F; border-color: #D32F2F; }"
)

BTN_DROPDOWN = (
    "QPushButton {"
    "  background-color: #1e1e1e; color: #eee;"
    "  border: 1px solid #333; border-radius: 3px;"
    "  font-size: 12px; padding: 6px 8px;"
    "}"
    "QPushButton:hover { background-color: #2a2a2a; border-color: #555; }"
    "QPushButton:disabled { color: #666; }"
)

DROPDOWN_OPTION = (
    "QPushButton {"
    "  background-color: transparent; color: #eee; border: none;"
    "  text-align: left; padding: 6px 12px; font-size: 12px;"
    "}"
    "QPushButton:hover { background-color: #2a2a2a; }"
)

DROPDOWN_CONTAINER = (
    "QWidget { background-color: #1e1e1e; border: 1px solid #333; border-radius: 3px; }"
)


# â”€â”€ Shared widgets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class ImageDisplay(QLabel):
    """Custom label that displays an image fully contained, never cropped."""

    clicked = pyqtSignal()

    def __init__(self, parent=None):
        super().__init__(parent)
        self._pixmap = None
        self.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self.setMinimumSize(64, 64)
        self.setStyleSheet("background-color: #121212; border: none;")

    def set_image(self, filepath: str):
        """Load and display an image from file path."""
        self._pixmap = QPixmap(filepath)
        self._update_display()
        self.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))

    def clear_image(self):
        self._pixmap = None
        self.clear()
        self.setCursor(QCursor(Qt.CursorShape.ArrowCursor))

    def mousePressEvent(self, event):
        if event.button() == Qt.MouseButton.LeftButton and self._pixmap:
            self.clicked.emit()
        super().mousePressEvent(event)

    def _update_display(self):
        if self._pixmap and not self._pixmap.isNull():
            scaled = self._pixmap.scaled(
                self.size(),
                Qt.AspectRatioMode.KeepAspectRatio,
                Qt.TransformationMode.SmoothTransformation,
            )
            self.setPixmap(scaled)

    def resizeEvent(self, event):
        super().resizeEvent(event)
        self._update_display()


# â”€â”€ Shared helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def make_dropdown(parent_widget, options: list, callback, event_filter_obj) -> QWidget:
    """Create a hover-activated dropdown widget with the given options.

    Args:
        parent_widget:    Widget whose window() is used as the dropdown parent.
        options:          List of string labels for the dropdown items.
        callback:         Called with the selected option string on click.
        event_filter_obj: QObject that will receive Enter/Leave events on the dropdown.
    """
    dd = QWidget(parent_widget.window() or None)
    dd.setWindowFlags(Qt.WindowType.FramelessWindowHint | Qt.WindowType.Tool)
    dd.setAttribute(Qt.WidgetAttribute.WA_ShowWithoutActivating)
    dd.setStyleSheet(DROPDOWN_CONTAINER)
    lo = QVBoxLayout(dd)
    lo.setContentsMargins(2, 2, 2, 2)
    lo.setSpacing(1)

    for opt in options:
        btn = QPushButton(opt)
        btn.setStyleSheet(DROPDOWN_OPTION)
        btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
        btn.clicked.connect(lambda _, o=opt: callback(o))
        lo.addWidget(btn)

    dd.adjustSize()
    dd.hide()
    dd.installEventFilter(event_filter_obj)
    return dd
```

### `core/config.py`

```python
"""Configuration Manager for PyQt6 GUI Framework."""
import os
import json

_DEFAULTS = {
    "window_width": 1200,
    "window_height": 800,
    "theme": "dark",
    "current_service": "Gemini",
    "current_model": "Flash",
    "default_system_prompt": "You are a helpful AI assistant.",
    "splitter_sizes": [780, 420],
    "media_active_tab": 0,
    "gallery_page": 1,
    "gallery_filter": "All",
    "pollinations_positive_prompt": "",
    "pollinations_negative_prompt": "",
    "pollinations_model": "zimage",
    "pollinations_size": "1024x1024",
    "pollinations_seed": -1,
    "pollinations_last_image": "",
    "airforce_positive_prompt": "",
    "airforce_negative_prompt": "",
    "airforce_model": "grok-imagine",
    "airforce_last_image": "",
    "perchance_url": "https://perchance.org/a1481832-0a06-414f-baa6-616052e5f61d",
    "adblocker": {
        "blocked_domains": [
            "a.pub.network",
            "d.pub.network",
            "cdn.snigelweb.com",
            "googletagmanager.com",
            "cloudflareinsights.com",
            "static.criteo.net",
            "secure.quantserve.com",
            "fundingchoicesmessages.google.com"
        ],
        "hidden_selectors": [
            ".ad-providers-ctn-el",
            "#adCtn",
            "#pmLink",
            "#menuBarEl",
            "#minimalModeMenuBtn"
        ]
    },
    "display_fields": {
        "core": True,
        "composition": True,
        "lighting": True,
        "style": True,
        "technical": True,
        "post_processing": True,
        "special_elements": True,
        "detailed_prompt": True,
        "grok_imagine_optimized": True,
        "gemini_optimized": True,
        "flux_optimized": True,
        "stable_diffusion_optimized": True,
        "video_optimized": True
    }
}

class ConfigManager:
    """Manages GUI configuration values and local gui_config.json persistence."""

    def __init__(self, config_file: str = "gui_config.json"):
        self.config_file = config_file
        self.__dict__.update(_DEFAULTS)
        self._load_config()

    def _load_config(self) -> None:
        if not os.path.exists(self.config_file):
            return
        try:
            with open(self.config_file, 'r') as f:
                config = json.load(f)
                for k in _DEFAULTS:
                    val = config.get(k, getattr(self, k))
                    if isinstance(val, dict) and isinstance(_DEFAULTS[k], dict):
                        merged = _DEFAULTS[k].copy()
                        merged.update(val)
                        setattr(self, k, merged)
                    else:
                        setattr(self, k, val)
                if "default_service" in config and "current_service" not in config:
                    self.current_service = config["default_service"]
                if "service_models" in config and "current_model" not in config:
                    self.current_model = config.get("service_models", {}).get(self.current_service, self.current_model)
        except Exception:
            pass

    def save(self) -> None:
        try:
            with open(self.config_file, 'w') as f:
                json.dump({k: getattr(self, k) for k in _DEFAULTS}, f, indent=2)
        except Exception:
            pass
```

### `core/utils.py`

```python
# core/utils.py
"""Shared utility functions for the application."""

import os
import sys
import subprocess
from datetime import datetime
from pathlib import Path


def reveal_file_in_explorer(filepath: str) -> bool:
    """
    Open the system file explorer and select/highlight the given file.

    Platform behavior:
        Windows: explorer /select,<path>
        macOS:   open -R <path>
        Linux:   xdg-open <parent directory>

    Returns True if the command was launched, False on error or missing file.
    """
    filepath = os.path.normpath(os.path.abspath(filepath))
    if not os.path.exists(filepath):
        return False
    try:
        if sys.platform == "win32":
            subprocess.Popen(["explorer", f"/select,{filepath}"])
        elif sys.platform == "darwin":
            subprocess.Popen(["open", "-R", filepath])
        else:
            subprocess.Popen(["xdg-open", os.path.dirname(filepath)])
        return True
    except Exception:
        return False


def open_file(filepath: str) -> bool:
    """
    Open a file with the system's default application.

    Returns True if the command was launched, False on error or missing file.
    """
    filepath = os.path.normpath(os.path.abspath(filepath))
    if not os.path.exists(filepath):
        return False
    try:
        if sys.platform == "win32":
            os.startfile(filepath)
        elif sys.platform == "darwin":
            subprocess.Popen(["open", filepath])
        else:
            subprocess.Popen(["xdg-open", filepath])
        return True
    except Exception:
        return False


def save_generated_image(
    image_data: bytes,
    prompt: str,
    negative_prompt: str,
    model: str,
    size: str,
    seed: int,
    service: str,
) -> str:
    """Save generated image to the images/ directory with embedded EXIF metadata.

    Uses a timestamp-based filename (``YYYY-MM-DD_HH-MM-SS.jpg``) and embeds
    prompt / generation metadata into the EXIF ImageDescription tag when
    Pillow is available.

    Args:
        image_data:      Raw image bytes (any format Pillow can open).
        prompt:          Positive prompt text.
        negative_prompt: Negative prompt text (may be empty).
        model:           Model identifier string.
        size:            Size string, e.g. ``"1024x1024"``.
        seed:            Seed value used for generation.
        service:         Service name (e.g. ``"Pollinations"``, ``"Airforce"``).

    Returns:
        The absolute-ish path to the saved file as a string.
    """
    images_dir = Path("images")
    images_dir.mkdir(exist_ok=True)

    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    filepath = images_dir / f"{timestamp}.jpg"
    counter = 1
    while filepath.exists():
        filepath = images_dir / f"{timestamp}_{counter}.jpg"
        counter += 1

    metadata_str = (
        f"Prompt: {prompt} | "
        f"Negative: {negative_prompt or 'None'} | "
        f"Model: {model} | "
        f"Size: {size} | "
        f"Seed: {seed} | "
        f"Service: {service}"
    )

    saved_with_meta = False
    try:
        from PIL import Image
        import io

        img = Image.open(io.BytesIO(image_data))
        if img.mode in ("RGBA", "P", "LA"):
            img = img.convert("RGB")

        exif = img.getexif()
        exif[0x010E] = metadata_str        # ImageDescription
        exif[0x0131] = f"{service} AI"     # Software
        img.save(str(filepath), "JPEG", quality=95, exif=exif.tobytes())
        saved_with_meta = True
    except Exception:
        pass

    if not saved_with_meta:
        with open(filepath, "wb") as f:
            f.write(image_data)

    return str(filepath)
```
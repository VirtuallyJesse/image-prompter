### TASK

This task has two phases.

Phase one: PURELY an informational gathering task and stage.
Phase two: Code execution and modifications

Both phases are for the following:

Perchance Page Enhancements - A div container block/hide, more metadata saving for EXIF, and auto-download

## TASK DETAILS

# CONTAINER TO HIDE

The perchance page began inserting a new div. I have copied the literal html from our perchance url using my browser inspector tol, this is where the div is hiding, please analyse and produce a summary of what we need to do to hide it:

```html
<div id="menuBarEl" style="position:relative; height:var(--menu-bar-height); min-height:var(--menu-bar-height); width:100%; overflow:hidden; display:flex; align-items: center; justify-content: center;">
            <script>
              if(window.generatorStaticMetaData.header?.mode === "minimal") { 
                menuBarEl.style.display = "none";
                minimalModeMenuBtn.style.display = "flex"; 
              }
              try {
                const mm = (q) => window.matchMedia(q).matches === true;
                if(mm("(display-mode: minimal-ui)") || mm("(display-mode: window-controls-overlay)") || mm("(display-mode: fullscreen)") || mm("(display-mode: standalone)") || window.navigator.standalone) {
                  menuBarEl.style.display = "none";
                  minimalModeMenuBtn.style.display = "flex"; 
                }
              } catch(e) {
                console.error(e);
              }
              function enableRobustBackdropFilter() { // this is more robust to e.g. background images, light backgrounds in dark mode, etc. - only enabling if background is actually set because IIRC some browsers currently have significant performance issues with backdrop-filter blur
                document.querySelector(':root').style.setProperty('--menu-bar-item-backdrop-filter', "brightness(0.9) blur(4px)");
                document.querySelector(':root').style.setProperty('--menu-bar-item-backdrop-filter-hover', "brightness(0.84) blur(4px)");
                document.querySelector(':root').style.setProperty('--menu-bar-item-backdrop-filter-dark', "brightness(0.75) blur(4px)");
                document.querySelector(':root').style.setProperty('--menu-bar-item-backdrop-filter-hover-dark', "brightness(0.6) blur(4px)");
              }  
              function colorIsDark(bgColorStr) {
                let a = document.createElement('div');
                a.style.color = bgColorStr;
                let rgb = window.getComputedStyle( document.body.appendChild(a) ).color.match(/\d+/g).map(function(a){ return parseInt(a,10); });
                document.body.removeChild(a);
                let r = rgb[0];
                let g = rgb[1];
                let b = rgb[2];
                let uicolors = [r / 255, g / 255, b / 255];
                let c = uicolors.map((col) => {
                  if (col <= 0.03928) {
                    return col / 12.92;
                  }
                  return Math.pow((col + 0.055) / 1.055, 2.4);
                });
                let L = (0.2126 * c[0]) + (0.7152 * c[1]) + (0.0722 * c[2]);
                return L < 0.179;
              }
              if(typeof window.generatorStaticMetaData.header?.background === "string") {
                if(CSS.supports("background", window.generatorStaticMetaData.header.background)) {
                  menuBarEl.style.background = window.generatorStaticMetaData.header.background;
                  enableRobustBackdropFilter();
                  if(CSS.supports("color", window.generatorStaticMetaData.header.background)) {
                    menuBarEl.style.color = colorIsDark(window.generatorStaticMetaData.header.background) ? "#e3e3e3" : "#050505";
                  }
                }
              }

              {
                let isTouchDevice = window.matchMedia("(pointer: coarse)").matches;
                let maxSeenViewportHeight = window.visualViewport.height;
                window.visualViewport.addEventListener('resize', () => {
                  if(!isTouchDevice) return;
                  if(window.visualViewport.height > maxSeenViewportHeight) maxSeenViewportHeight = window.visualViewport.height;
                  if(window.generatorStaticMetaData.header?.mode !== "minimal") {
                    menuBarEl.style.display = window.visualViewport.height < 0.8*maxSeenViewportHeight ? "none" : "flex"; 
                  }
                });
              }
            </script>
            <div class="container" style="height: calc(100% - 0.42rem); width: calc(100% - 0.42rem); display: flex;">
              <div style="display:flex; height:100%; gap:0.21rem; overflow:hidden; flex-wrap:wrap;">
                <div class="menu-item" style="aspect-ratio: 1 / 1;" onclick="window.open('/')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-icon" style="padding:0; font-size:0.9rem;">‚öÑÔ∏é</span>
                </div>
                <div data-ref="communityButton" class="menu-item community" onclick="window.open('https://lemmy.world/c/perchance')" onmousedown="if(event.which===2) { this.click() }" title="‚Ä¢ &quot;[Bug] ban IP conflict (request)&quot; (1d ago)
‚Ä¢ &quot;[BUG] gen list An error has occurred near line number 40&quot; (2d ago)
‚Ä¢ &quot;[HeLp] $meta HTML tag?&quot; (3d ago)
‚Ä¢ &quot;Errors while exporting character data on Brave/chrome&quot; (4d ago)
‚Ä¢ &quot;How do I set the header bar to collapse?&quot; (6d ago)
‚Ä¢ &quot;Please fix it&quot; (6d ago)
‚Ä¢ &quot;AI is down for image and text ?&quot; (6d ago)
‚Ä¢ &quot;Whats happening with the advanced character chat?&quot; (6d ago)">
                  <span class="menu-item-icon">üë•Ô∏é</span>
                  <span class="menu-item-label" style="padding-right:0;">forum</span>
                  <span style="font-size:70%; display:inline-block; text-align:center; opacity:0.7; padding-right:0.25rem;" data-ref="communityNotifications"> (1d)</span>
                </div>
                <div class="menu-item hub" onclick="window.open('/hub')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-icon">üåà</span>
                  <span class="menu-item-label">hub</span>
                </div>
                <div class="menu-item tutorial" onclick="window.open('/tutorial')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-icon">üìö</span>
                  <span class="menu-item-label">learn</span>
                </div>
                <!-- <div class="menu-item tutorial" onclick="window.open('/resources')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-icon">üß∞</span>
                  <span class="menu-item-label">resources</span>
                </div> -->
                <div class="menu-item generators" onclick="window.open('/generators')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-inner"><span class="menu-item-icon">üé≤Ô∏é</span>
                  <span class="menu-item-label">generators</span></span>
                </div>
                <div class="menu-item new" onclick="window.open('/minimal#edit')" onmousedown="if(event.which===2) { this.click() }">
                  <span class="menu-item-icon">‚ûï</span>
                  <span class="menu-item-label">new</span>
                </div><div class="menu-item promo" onclick="window.open('/ai-chat')" onmousedown="if(event.which===2) { this.click() }" style="background-color: rgb(110, 53, 11);">
                  <span class="menu-item-icon">üÜï</span>
                  <span class="menu-item-label">ai chat</span>
                </div>
              </div>
              <div style="display:flex; height:100%; flex-grow:1; justify-content:end; gap:0.21rem;">
                <div data-ref="statusMessage" style="min-width:max-content; color:green; padding:0 0.5em; font-size: 80%; display:none; align-items: center; justify-content: center; font-weight: bold;"></div>
                <div data-ref="revisionsButton" class="menu-item" onclick="app.openRevisionsModal()" style="display:none;">
                  <span class="menu-item-icon">üóÑÔ∏è</span>
                  <span class="menu-item-label">backups</span>
                </div>
                <div data-ref="saveButton" class="menu-item" onclick="app.saveGenerator();" style="display:none; ">
                  <span class="menu-item-icon">üíæ</span>
                  <span class="menu-item-label" data-ref="saveText">save</span>
                </div>
                <div data-ref="settingsButton" onclick="app.openSettingsModal()" class="menu-item" style="display:none;">
                  <span class="menu-item-icon">‚öôÔ∏è</span>
                  <span class="menu-item-label">settings</span>
                </div>
                <div data-ref="editButton" class="menu-item edit-generator-button" onclick="window.lastEditButtonClickTime=Date.now(); app.goToEditMode()" style="color: green; display: inline-flex;">
                  <span class="menu-item-icon">üõ†Ô∏è</span>
                  <span class="menu-item-label">edit</span>
                </div>
                <div data-ref="accountButton" onclick="app.openAccountModal()" class="menu-item account-modal-open-button" style="display:none; color:green;">
                  <span class="menu-item-icon">üë§</span>
                  <span class="menu-item-label">account</span>
                </div>
                <div data-ref="loginButton" onclick="app.openLoginModal()" class="menu-item" style="display: inline-flex;">
                  <span class="menu-item-icon">üîë</span>
                  <span class="menu-item-label">login</span>
                </div>
                <div id="backToMinimalModeBtn" class="menu-item" onclick="menuBarEl.style.display='none'; minimalModeMenuBtn.style.display='flex';" style="display:none; aspect-ratio: 1/1;">
                  <span class="menu-item-icon" style="padding: 0; font-size: 0.5rem; line-height: 0.4rem;">‚ùå</span>
                </div>
              </div>
            </div>
            <script> 
              window.menuBar = {
                root: document.querySelector("#menuBarEl"),
                refs: new Proxy({}, {
                  get(target, prop, receiver) {
                    return document.querySelector(`#menuBarEl [data-ref='${prop}']`);
                  },
                }),
                init: function() {

                  try {
                    this.refs.editButton.addEventListener("mouseover", () => {
                      if(window.TEST_NEW_EDITOR_1 && !window.editorBundleImportPromise) window.editorBundleImportPromise = import("/lib/editors.bundle.min.js?v=77");
                    });
                  } catch(e) { console.error(e); }

                  this.updateMenuButtonsDisplay = function() {
                    this.refs.accountButton.style.display = app.store.data.user.loggedIn ? "inline-flex" : "none";
                    this.refs.loginButton.style.display = app.store.data.user.loggedIn ? "none" : "inline-flex";
                    this.refs.settingsButton.style.display = app.store.data.user.loggedIn && window.userOwnsThisGenerator && app.appInteractionState === "edit" ? "inline-flex" : "none";
                    this.refs.saveButton.style.display = app.appInteractionState === "edit" ? "inline-flex" : "none";
                    this.refs.revisionsButton.style.display = app.store.data.user.loggedIn && window.userOwnsThisGenerator && app.appInteractionState === "edit" ? "inline-flex" : "none";
                    this.refs.editButton.style.display = app.appInteractionState === "view" ? "inline-flex" : "none";
                  };
                  app.on("LoginStateChange", () => {
                    this.updateMenuButtonsDisplay();
                  });
                  app.on("AppInteractionStateChange", () => {
                    this.updateMenuButtonsDisplay();
                    if(app.interactionStateChange === "edit") {
                      this.updateSaveButtonStyle();
                    }
                  });
                  app.on("GeneratorOwnershipChange", () => {
                    this.updateMenuButtonsDisplay();
                  });

                  // this will be changed to "saved" if they are the owner:
                  window.perchanceSaveState = "unsaved";
                  this.saveState = "unsaved";
                
                  this.setSaveState = (state) => {
                    window.perchanceSaveState = state;
                    this.saveState = state;
                    this.updateSaveButtonStyle();
                  };
                  window.setSaveState = this.setSaveState.bind(this);
                
                  this.updateSaveButtonStyle = () => {
                
                    let state = this.saveState;
                
                    this.refs.saveButton.style.color = "";
                    this.refs.saveButton.style.cursor = "";
                    this.refs.saveButton.style.opacity = 1;
                
                    if(state === "saving") {
                      this.refs.saveText.innerText = "saving‚Ä¶";
                      this.refs.saveButton.style.opacity = 0.5;
                    } else if(state === "saved") {
                      this.refs.saveText.innerText = "saved";
                      this.refs.saveButton.style.opacity = 0.5;
                    } else if(state === "unsaved") {
                      this.refs.saveText.innerText = "save";
                      this.refs.saveButton.style.cursor = "pointer";
                    } else if(state === "error") {
                      this.refs.saveText.innerText = "error";
                      this.refs.saveButton.style.color = "red";
                    } else {
                      console.error("Invalid save state.");
                      this.setSaveState("INVALID!");
                      alert("There was an error while saving :S Please report this at lemmy.world/c/perchance if the problem persists.");
                      //this.saveState = "INVALID!";
                    }
                  };
                
                  this.updateCommunityData = async () => {
                    try {
                      let communityData = await (await fetch("/api/getCommunityData")).json();
                      if(communityData.status !== "success") throw communityData;
                      let data = communityData.data;
                      let str = "";
                      let isMostRecentPost = true;
                      let mostRecentPostTimeAgoStr = "";
                      for(let post of data.posts) {
                        let minsAgo = Math.ceil(post.secondsAgo/60);
                        let timeAgoStr = minsAgo > 60*24 ? Math.round(minsAgo/(60*24))+"d" : minsAgo > 60 ? Math.ceil(minsAgo/60)+"h" : minsAgo+"m";
                        if(isMostRecentPost) mostRecentPostTimeAgoStr = timeAgoStr;
                        str += `‚Ä¢ "${post.title}" (${timeAgoStr} ago)\n`;
                        isMostRecentPost = false;
                      }
                      if(data.posts[0]/60 > 60*24) {
                        this.refs.communityNotifications.textContent = "";
                        this.refs.communityNotifications.style.display = "none";
                      } else {
                        this.refs.communityNotifications.textContent = " ("+mostRecentPostTimeAgoStr+")";
                        this.refs.communityNotifications.style.display = "inline-block";
                      }
                      this.refs.communityButton.title = str.trim(); // XSS no possible with setting title but CAREFUL if you change this code
                    } catch(e) {
                      console.error("Failed to update community data.");
                    }
                  };
                
                  this.updateCommunityData();
                  setInterval(this.updateCommunityData, 2*60*1000);
                },
              };
            </script>
          </div>
```

Hiding this will not block our ability to log in, don't worry. It's a navigation bar hosting options like forum, hub, etc.

# METADATA

To explain how perchance top bar differs, here is how it looks on the URL:
Generate -> (positive) prompt -> negative prompt -> focus (this is a field that acts as an extension of the positive prompt, and is to be ignored) -> style (this is a dropdown which again, manipulates the positive prompt by appending words, and is to be ignored) -> size -> seed -> guidance scale

On the perchance page, after image generation, if I hover my mouse over the images, it displays in a standard browser hover event popup in text the data used for prompt, negative prompt, seed, and guidanceScale. The only thing lacking is the size parameter, but we can directly extrapolate that from the images themselves to be inserted into the exif. 

We need to find a way to read/expose this information before/as we download. It's there, just need to grab it.

# AUTO-DOWNLOAD

The project might suggest we already perform auto-downloading for Perchance. This is incorrect. On the page, if you mouse over a generated image, in the bottom left is a heart icon. If you click the heart icon, another menu appears over the image, with an option `save to your device`. This is how users have been saving perchance images to disk, and where our script currently hooks in.

We need to find a way to truly auto-download files without requiring these actions. Investigate.

### PROJECT 

Image Assistant is a PyQt6 desktop application that transforms user concepts into optimized image generation prompts via AI services (Gemini, NVIDIA NIM), with integrated text-to-image synthesis through Pollinations, Airforce, and Perchance APIs.

### DELIVERABLES

We are to begin by testing in my web browser, which is functionally the same as in the application since we load from an iframe. You will provide javascript in which I can execute in my browser console to attempt and isolate some of the required information to then implement into the project ocdebase.

Phase one will proceed indefinitely in a turn order: javascript (you) -> execution/log (me), until you are satisfied with the result.

Once you are ready to proceed, for phase two please output a brief summary including any design choices, and the updated or new files where applicable. You have authority to create, delete, or consolidate services or modules. If only small changes to existing files are required, please output them in

SEARCH: 

```
...stuff...
``` 

REPLACE:

```
...stuff...
``` 

style blocks. Never include backwards compatibility; if you want to rename a handler or file, then rename it. We'll deal with unexpected fallout to ensure names match expected behaviors.

### CONTEXT

## üéØ Focused Context (Agent-Selected)

**Project Root:** `image-prompter/`
**Files Included:** 6

---

### File Index

1. `core/services/perchance_service.py`
2. `gui/widgets/perchance_page.py`
3. `core/utils.py`
4. `core/services/gallery_service.py`
5. `gui/widgets/media_panel.py`
6. `core/config.py`

---

### `core/services/perchance_service.py`

```python
# core/services/perchance_service.py
"""
Perchance Service ‚Äì WebEngine profile management, ad blocking, and image
download handling for the embedded Perchance image generator.
"""

import os
from datetime import datetime
from pathlib import Path

_WEBENGINE_AVAILABLE = False
try:
    from PyQt6.QtWebEngineCore import (
        QWebEngineProfile,
        QWebEnginePage,
        QWebEngineUrlRequestInterceptor,
    )
    _WEBENGINE_AVAILABLE = True
except ImportError:
    QWebEngineUrlRequestInterceptor = None


def is_webengine_available() -> bool:
    """Return *True* if PyQt6-WebEngine is installed and importable."""
    return _WEBENGINE_AVAILABLE


# ‚îÄ‚îÄ Ad-block request interceptor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

if _WEBENGINE_AVAILABLE:

    class AdBlockInterceptor(QWebEngineUrlRequestInterceptor):
        """Block network requests whose URL contains a blocked-domain substring."""

        def __init__(self, blocked_domains: list, parent=None):
            super().__init__(parent)
            self.blocked_domains = blocked_domains or []

        def interceptRequest(self, info):
            url = info.requestUrl().toString()
            for domain in self.blocked_domains:
                if domain in url:
                    info.block(True)
                    return


# ‚îÄ‚îÄ Service class ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class PerchanceService:
    """
    Creates a persistent WebEngine profile with ad-blocking and handles
    image downloads from the embedded Perchance page.
    """

    DEFAULT_BLOCKED_DOMAINS = [
        "a.pub.network",
        "d.pub.network",
        "cdn.snigelweb.com",
        "googletagmanager.com",
        "cloudflareinsights.com",
        "static.criteo.net",
        "secure.quantserve.com",
        "fundingchoicesmessages.google.com",
    ]

    DEFAULT_HIDDEN_SELECTORS = [
        ".ad-providers-ctn-el",
        "#adCtn",
        "#pmLink",
    ]

    def __init__(self, config_manager=None):
        self.config_manager = config_manager
        self._profile = None
        self._interceptor = None
        self._page = None
        self._status_callback = None

    # -- External setters ------------------------------------------------

    def set_page(self, page):
        """Store a reference to the active QWebEnginePage for JS access."""
        self._page = page

    def set_status_callback(self, callback):
        """Register a callable for status messages (e.g. a pyqtSignal emit)."""
        self._status_callback = callback

    def _emit_status(self, msg: str):
        if self._status_callback:
            self._status_callback(msg)

    # ‚îÄ‚îÄ Profile creation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def create_profile(self, parent=None):
        """
        Build a *persistent* QWebEngineProfile:

        * Disk-backed cookies (login survives restarts)
        * Ad-blocking request interceptor
        * Download-requested handler for saving images

        Returns the profile, or ``None`` when WebEngine is unavailable.
        """
        if not _WEBENGINE_AVAILABLE:
            return None

        from PyQt6.QtCore import QStandardPaths

        base = QStandardPaths.writableLocation(
            QStandardPaths.StandardLocation.AppDataLocation
        )
        storage_root = os.path.join(base, "webengine", "perchance")
        os.makedirs(storage_root, exist_ok=True)

        profile = QWebEngineProfile("perchance", parent)
        profile.setPersistentStoragePath(os.path.join(storage_root, "storage"))
        profile.setCachePath(os.path.join(storage_root, "cache"))
        profile.setHttpCacheType(QWebEngineProfile.HttpCacheType.DiskHttpCache)

        try:
            profile.setPersistentCookiesPolicy(
                QWebEngineProfile.PersistentCookiesPolicy.ForcePersistentCookies
            )
        except AttributeError:
            pass  # older PyQt6 build without this enum

        # Layer 1 ‚Äì network-level ad blocking
        blocked = self._get_blocked_domains()
        if blocked:
            self._interceptor = AdBlockInterceptor(blocked, parent)
            profile.setUrlRequestInterceptor(self._interceptor)

        # Image download handling
        profile.downloadRequested.connect(self._on_download_requested)

        self._profile = profile
        return profile

    # ‚îÄ‚îÄ Ad-hide JavaScript (Layer 2) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def get_ad_hide_script(self) -> str:
        """
        Return a JavaScript snippet that hides ad-related DOM elements and
        watches for dynamically inserted ones via MutationObserver.
        """
        selectors = self._get_hidden_selectors()
        if not selectors:
            return ""

        selectors_js = ", ".join(f'"{s}"' for s in selectors)
        return f"""
(function() {{
    if (window._perchanceAdblockActive) return;
    window._perchanceAdblockActive = true;

    var selectors = [{selectors_js}];

    function hide() {{
        selectors.forEach(function(s) {{
            document.querySelectorAll(s).forEach(function(el) {{
                el.style.setProperty('display', 'none', 'important');
                el.style.setProperty('visibility', 'hidden', 'important');
                el.style.position = 'absolute';
                el.style.left = '-9999px';
            }});
        }});
    }}

    hide();
    setTimeout(hide, 1000);
    setTimeout(hide, 3000);

    var obs = new MutationObserver(function() {{ hide(); }});
    if (document.body) {{
        obs.observe(document.body, {{ childList: true, subtree: true }});
    }} else {{
        document.addEventListener('DOMContentLoaded', function() {{
            hide();
            obs.observe(document.body, {{ childList: true, subtree: true }});
        }});
    }}
}})();
"""

    # ‚îÄ‚îÄ Download handling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _on_download_requested(self, download):
        """
        Accept image downloads and redirect them to ``images/`` with a
        timestamp-based temporary filename.  Non-image downloads are
        silently ignored.
        """
        try:
            mime_type = (download.mimeType() or "").lower()
            dl_name = (download.downloadFileName() or "").lower()
            is_image = mime_type.startswith("image/") or dl_name.endswith(
                (".png", ".jpg", ".jpeg", ".webp", ".gif")
            )
            if not is_image:
                return

            images_dir = Path("images")
            images_dir.mkdir(exist_ok=True)

            timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
            orig_ext = Path(download.downloadFileName() or "image.png").suffix or ".png"
            temp_name = f"_perchance_tmp_{timestamp}{orig_ext}"

            download.setDownloadDirectory(str(images_dir.resolve()))
            download.setDownloadFileName(temp_name)

            # Best-effort prompt capture via async JS callback
            captured = {"prompt": ""}
            if self._page:
                self._page.runJavaScript(
                    "(function(){var e=document.querySelector('textarea');"
                    "return e?e.value:'';})()",
                    lambda result, c=captured: c.update({"prompt": result or ""}),
                )

            temp_path = images_dir / temp_name

            download.isFinishedChanged.connect(
                lambda tp=temp_path, ts=timestamp, cap=captured: self._finalize_download(
                    tp, ts, cap
                )
            )

            download.accept()
            self._emit_status("Downloading image from Perchance\u2026")

        except Exception as e:
            self._emit_status(f"Download error: {e}")

    def _finalize_download(self, temp_path: Path, timestamp: str, captured: dict):
        """
        Post-process a completed download:

        1. Open with Pillow (if available)
        2. Convert to RGB JPEG
        3. Embed EXIF metadata (prompt + service)
        4. Remove the temporary file

        Falls back to a simple rename when Pillow is absent.
        """
        if not temp_path.exists():
            return
        try:
            if temp_path.stat().st_size == 0:
                temp_path.unlink(missing_ok=True)
                return
        except OSError:
            return

        images_dir = temp_path.parent
        prompt = captured.get("prompt", "")

        # Determine unique final path
        final_path = images_dir / f"{timestamp}.jpg"
        counter = 1
        while final_path.exists():
            final_path = images_dir / f"{timestamp}_{counter}.jpg"
            counter += 1

        saved = False
        try:
            from PIL import Image

            img = Image.open(str(temp_path))
            if img.mode in ("RGBA", "P", "LA"):
                img = img.convert("RGB")

            parts = []
            if prompt:
                parts.append(f"Prompt: {prompt}")
            parts.append("Service: Perchance")
            metadata_str = " | ".join(parts)

            exif = img.getexif()
            exif[0x010E] = metadata_str      # ImageDescription
            exif[0x0131] = "Perchance AI"    # Software
            img.save(str(final_path), "JPEG", quality=95, exif=exif.tobytes())
            saved = True
        except ImportError:
            pass
        except Exception as e:
            self._emit_status(f"Image conversion note: {e}")

        if not saved:
            # Fallback: rename temp file directly
            try:
                temp_path.rename(final_path)
                saved = True
            except OSError:
                pass

        # Clean up temp file (Pillow path leaves it behind)
        if temp_path.exists():
            try:
                temp_path.unlink(missing_ok=True)
            except OSError:
                pass

        if saved:
            self._emit_status(f"Image saved: {final_path.name}")

    # ‚îÄ‚îÄ Config helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _get_blocked_domains(self) -> list:
        if self.config_manager:
            ab = getattr(self.config_manager, "adblocker", {})
            if isinstance(ab, dict) and ab.get("blocked_domains"):
                return ab["blocked_domains"]
        return self.DEFAULT_BLOCKED_DOMAINS

    def _get_hidden_selectors(self) -> list:
        if self.config_manager:
            ab = getattr(self.config_manager, "adblocker", {})
            if isinstance(ab, dict) and ab.get("hidden_selectors"):
                return ab["hidden_selectors"]
        return self.DEFAULT_HIDDEN_SELECTORS
```

### `gui/widgets/perchance_page.py`

```python
# gui/widgets/perchance_page.py
"""
Perchance Page ‚Äì Embeds a Perchance image generator in a QWebEngineView
with ad-blocking and persistent login / cookie storage.
"""

from PyQt6.QtWidgets import QWidget, QVBoxLayout, QLabel, QSizePolicy
from PyQt6.QtCore import pyqtSignal, Qt

from core.services.perchance_service import PerchanceService, is_webengine_available

PERCHANCE_URL = "https://perchance.org/a1481832-0a06-414f-baa6-616052e5f61d"


class PerchancePage(QWidget):
    """
    Perchance image generation page.

    Loads the Perchance generator URL inside a QWebEngineView with:

    * Persistent cookie / login profile
    * Two-layer ad blocking (request interception + DOM hiding)
    * Automatic image-download handling to ``images/``

    Falls back to a static label when PyQt6-WebEngine is not installed.
    """

    status_updated = pyqtSignal(str)

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.config_manager = config_manager
        self.service = PerchanceService(config_manager)
        self.service.set_status_callback(self.status_updated.emit)

        self._webview = None
        self._page = None
        self._url_loaded = False

        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self._build_ui()

    # ‚îÄ‚îÄ UI construction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        if not is_webengine_available():
            self._build_fallback(layout)
            return

        try:
            from PyQt6.QtWebEngineWidgets import QWebEngineView
            from PyQt6.QtWebEngineCore import QWebEnginePage

            # Persistent profile (cookies, ad-blocking, download handling)
            profile = self.service.create_profile(self)
            if not profile:
                self._build_fallback(layout)
                return

            self._webview = QWebEngineView()
            self._page = QWebEnginePage(profile, self._webview)
            self._webview.setPage(self._page)

            # Give service access to the page for JS prompt extraction
            self.service.set_page(self._page)

            # Inject ad-hiding JS after each page load
            self._webview.loadFinished.connect(self._on_load_finished)

            layout.addWidget(self._webview, 1)

        except Exception as e:
            self._build_fallback(layout, str(e))

    def _build_fallback(self, layout, error_msg=None):
        """Display an informational placeholder when WebEngine is unavailable."""
        container = QWidget()
        cl = QVBoxLayout(container)
        cl.setAlignment(Qt.AlignmentFlag.AlignCenter)

        icon = QLabel("\U0001f3b2")  # üé≤
        icon.setStyleSheet("font-size: 32pt;")
        icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        cl.addWidget(icon)

        title = QLabel("Perchance")
        title.setStyleSheet("color: #666; font-size: 14pt; font-weight: bold;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        cl.addWidget(title)

        lines = ["PyQt6-WebEngine is required for Perchance integration."]
        if error_msg:
            lines.append(f"\n{error_msg}")
        lines.append("\nInstall:  pip install PyQt6-WebEngine")
        lines.append(f"\nOr visit directly:\n{PERCHANCE_URL}")

        desc = QLabel("\n".join(lines))
        desc.setStyleSheet("color: #888; font-size: 9pt;")
        desc.setAlignment(Qt.AlignmentFlag.AlignCenter)
        desc.setWordWrap(True)
        desc.setTextInteractionFlags(Qt.TextInteractionFlag.TextSelectableByMouse)
        cl.addWidget(desc)

        layout.addWidget(container)

    # ‚îÄ‚îÄ Events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def showEvent(self, event):
        """Lazy-load the URL on first show to avoid heavy init at startup."""
        super().showEvent(event)
        if self._webview and not self._url_loaded:
            self._url_loaded = True
            from PyQt6.QtCore import QUrl

            url = PERCHANCE_URL
            if self.config_manager:
                url = getattr(self.config_manager, "perchance_url", url) or url
            self._webview.setUrl(QUrl(url))

    def _on_load_finished(self, ok: bool):
        """Inject ad-hiding JavaScript after the page finishes loading."""
        if not ok or not self._page:
            return
        script = self.service.get_ad_hide_script()
        if script:
            self._page.runJavaScript(script)
```

### `core/utils.py`

```python
# core/utils.py
"""Shared utility functions for the application."""

import os
import sys
import subprocess
from datetime import datetime
from pathlib import Path


def reveal_file_in_explorer(filepath: str) -> bool:
    """
    Open the system file explorer and select/highlight the given file.

    Platform behavior:
        Windows: explorer /select,<path>
        macOS:   open -R <path>
        Linux:   xdg-open <parent directory>

    Returns True if the command was launched, False on error or missing file.
    """
    filepath = os.path.normpath(os.path.abspath(filepath))
    if not os.path.exists(filepath):
        return False
    try:
        if sys.platform == "win32":
            subprocess.Popen(["explorer", f"/select,{filepath}"])
        elif sys.platform == "darwin":
            subprocess.Popen(["open", "-R", filepath])
        else:
            subprocess.Popen(["xdg-open", os.path.dirname(filepath)])
        return True
    except Exception:
        return False


def open_file(filepath: str) -> bool:
    """
    Open a file with the system's default application.

    Returns True if the command was launched, False on error or missing file.
    """
    filepath = os.path.normpath(os.path.abspath(filepath))
    if not os.path.exists(filepath):
        return False
    try:
        if sys.platform == "win32":
            os.startfile(filepath)
        elif sys.platform == "darwin":
            subprocess.Popen(["open", filepath])
        else:
            subprocess.Popen(["xdg-open", filepath])
        return True
    except Exception:
        return False


def save_generated_image(
    image_data: bytes,
    prompt: str,
    negative_prompt: str,
    model: str,
    size: str,
    seed: int,
    service: str,
) -> str:
    """Save generated image to the images/ directory with embedded EXIF metadata.

    Uses a timestamp-based filename (``YYYY-MM-DD_HH-MM-SS.jpg``) and embeds
    prompt / generation metadata into the EXIF ImageDescription tag when
    Pillow is available.

    Args:
        image_data:      Raw image bytes (any format Pillow can open).
        prompt:          Positive prompt text.
        negative_prompt: Negative prompt text (may be empty).
        model:           Model identifier string.
        size:            Size string, e.g. ``"1024x1024"``.
        seed:            Seed value used for generation.
        service:         Service name (e.g. ``"Pollinations"``, ``"Airforce"``).

    Returns:
        The absolute-ish path to the saved file as a string.
    """
    images_dir = Path("images")
    images_dir.mkdir(exist_ok=True)

    timestamp = datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    filepath = images_dir / f"{timestamp}.jpg"
    counter = 1
    while filepath.exists():
        filepath = images_dir / f"{timestamp}_{counter}.jpg"
        counter += 1

    metadata_str = (
        f"Prompt: {prompt} | "
        f"Negative: {negative_prompt or 'None'} | "
        f"Model: {model} | "
        f"Size: {size} | "
        f"Seed: {seed} | "
        f"Service: {service}"
    )

    saved_with_meta = False
    try:
        from PIL import Image
        import io

        img = Image.open(io.BytesIO(image_data))
        if img.mode in ("RGBA", "P", "LA"):
            img = img.convert("RGB")

        exif = img.getexif()
        exif[0x010E] = metadata_str        # ImageDescription
        exif[0x0131] = f"{service} AI"     # Software
        img.save(str(filepath), "JPEG", quality=95, exif=exif.tobytes())
        saved_with_meta = True
    except Exception:
        pass

    if not saved_with_meta:
        with open(filepath, "wb") as f:
            f.write(image_data)

    return str(filepath)
```

### `core/services/gallery_service.py`

```python
# core/services/gallery_service.py
"""
Gallery Service - Reads and caches image metadata from the generated images directory.
"""

from pathlib import Path
from dataclasses import dataclass
from typing import List, Dict

@dataclass
class ImageMetadata:
    filepath: str
    prompt: str
    service: str
    model: str
    timestamp: str


class GalleryService:
    def __init__(self):
        self._cache: Dict[str, tuple[float, ImageMetadata]] = {}
        self.images_dir = Path("images")
        self.images_dir.mkdir(exist_ok=True)
        
    def get_images(self, filter_service: str = "All") -> List[ImageMetadata]:
        images = []
        if not self.images_dir.exists():
            return images
            
        for p in self.images_dir.glob("*.jpg"):
            try:
                mtime = p.stat().st_mtime
                filepath_str = str(p)
                
                # Check cache mapping via modified time
                if filepath_str in self._cache and self._cache[filepath_str][0] == mtime:
                    meta = self._cache[filepath_str][1]
                else:
                    meta = self._parse_metadata(p)
                    self._cache[filepath_str] = (mtime, meta)
                    
                if filter_service == "All" or meta.service.lower() == filter_service.lower():
                    images.append(meta)
            except Exception:
                continue
                
        # Sort by filepath descending (newest timestamp first)
        images.sort(key=lambda x: x.filepath, reverse=True)
        return images
        
    def _parse_metadata(self, filepath: Path) -> ImageMetadata:
        prompt = ""
        service = "Unknown"
        model = "Unknown"
        timestamp = filepath.stem
        
        try:
            from PIL import Image
            with Image.open(filepath) as img:
                exif = img.getexif()
                if exif and 0x010E in exif:
                    meta_str = exif[0x010E]
                    parts = [p.strip() for p in meta_str.split("|")]
                    for part in parts:
                        if part.startswith("Prompt:"):
                            prompt = part[7:].strip()
                        elif part.startswith("Service:"):
                            service = part[8:].strip()
                        elif part.startswith("Model:"):
                            model = part[6:].strip()
        except Exception:
            pass
            
        return ImageMetadata(str(filepath), prompt, service, model, timestamp)
```

### `gui/widgets/media_panel.py`

```python
# gui/widgets/media_panel.py
"""
Media Panel - Secondary pane for generative imaging interfacing.
Provides tabbed navigation for different image generation APIs.
"""

from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QPushButton,
    QStackedWidget, QLabel, QSizePolicy
)
from PyQt6.QtCore import Qt, pyqtSignal
from PyQt6.QtGui import QCursor
from gui.widgets.pollinations_page import PollinationsPage
from gui.widgets.airforce_page import AirforcePage
from gui.widgets.perchance_page import PerchancePage


class MediaPanel(QWidget):
    """Secondary pane with tabbed navigation for image generation API interfaces."""

    status_updated = pyqtSignal(str)

    TAB_NAMES = ["Gallery", "Pollinations", "Airforce", "Perchance"]

    ACTIVE_BG = "#1E88E5"
    ACTIVE_HOVER = "#2A9BF8"
    INACTIVE_BG = "#2a2a2a"
    INACTIVE_HOVER = "#3d3d3d"

    _TAB_ICONS = {"Gallery": "üñºÔ∏è", "Pollinations": "üå∏", "Airforce": "‚úàÔ∏è", "Perchance": "üé≤"}
    _TAB_DESCS = {
        "Gallery": "Generated images will appear here",
        "Pollinations": "Pollinations AI image generation",
        "Airforce": "Airforce image generation API",
        "Perchance": "Perchance image generation",
    }

    def __init__(self, config_manager=None, parent=None):
        super().__init__(parent)
        self.config_manager = config_manager
        self.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
        self._current_tab = 0
        self._tabs = []
        self._build_ui()
        self._load_active_tab()

    def _build_ui(self):
        layout = QVBoxLayout(self)
        layout.setContentsMargins(0, 0, 0, 0)
        layout.setSpacing(0)

        # --- Tab bar ---
        tab_bar = QWidget()
        tab_bar.setFixedHeight(34)
        tab_bar.setStyleSheet("background-color: #1a1a1a;")
        tab_layout = QHBoxLayout(tab_bar)
        tab_layout.setContentsMargins(0, 0, 0, 0)
        tab_layout.setSpacing(1)

        for i, name in enumerate(self.TAB_NAMES):
            btn = QPushButton(name)
            btn.setCursor(QCursor(Qt.CursorShape.PointingHandCursor))
            btn.setFocusPolicy(Qt.FocusPolicy.NoFocus)
            btn.setSizePolicy(QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding)
            btn.clicked.connect(lambda _, idx=i: self._switch_tab(idx))
            self._tabs.append(btn)
            tab_layout.addWidget(btn)

        layout.addWidget(tab_bar)

        # --- Stacked content area ---
        self._stack = QStackedWidget()
        self._stack.setStyleSheet("background-color: #2a2a2a; border: 1px solid #333;")

        from gui.widgets.gallery_page import GalleryPage
        for name in self.TAB_NAMES:
            if name == "Gallery":
                self.gallery_page = GalleryPage(self.config_manager)
                self.gallery_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.gallery_page)
            elif name == "Pollinations":
                self.pollinations_page = PollinationsPage(self.config_manager)
                self.pollinations_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.pollinations_page)
            elif name == "Airforce":
                self.airforce_page = AirforcePage(self.config_manager)
                self.airforce_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.airforce_page)
            elif name == "Perchance":
                self.perchance_page = PerchancePage(self.config_manager)
                self.perchance_page.status_updated.connect(self.status_updated.emit)
                self._stack.addWidget(self.perchance_page)
            else:
                self._stack.addWidget(self._create_page(name))

        layout.addWidget(self._stack, 1)
        self._update_tab_styles()

    def _create_page(self, name: str) -> QWidget:
        """Create a placeholder page for a tab."""
        page = QWidget()
        page_layout = QVBoxLayout(page)
        page_layout.setAlignment(Qt.AlignmentFlag.AlignCenter)

        icon = QLabel(self._TAB_ICONS.get(name, "üìÑ"))
        icon.setStyleSheet("font-size: 32pt;")
        icon.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(icon)

        title = QLabel(name)
        title.setStyleSheet("color: #666; font-size: 14pt; font-weight: bold;")
        title.setAlignment(Qt.AlignmentFlag.AlignCenter)
        page_layout.addWidget(title)

        desc = QLabel(self._TAB_DESCS.get(name, ""))
        desc.setStyleSheet("color: #444; font-size: 9pt;")
        desc.setAlignment(Qt.AlignmentFlag.AlignCenter)
        desc.setWordWrap(True)
        page_layout.addWidget(desc)

        return page

    def _switch_tab(self, index: int):
        """Switch to the specified tab index."""
        if index == self._current_tab:
            return
        self._current_tab = index
        self._stack.setCurrentIndex(index)
        self._update_tab_styles()
        
        current_widget = self._stack.widget(index)
        if hasattr(current_widget, "refresh"):
            current_widget.refresh()
            
        if self.config_manager:
            self.config_manager.media_active_tab = index
            self.config_manager.save()

    def _load_active_tab(self):
        """Restore the last active tab from config."""
        if self.config_manager:
            tab = getattr(self.config_manager, 'media_active_tab', 0)
            if 0 <= tab < len(self.TAB_NAMES):
                self._current_tab = tab
                self._stack.setCurrentIndex(tab)
                self._update_tab_styles()

    def _update_tab_styles(self):
        """Update tab button visual styles based on active selection."""
        for i, btn in enumerate(self._tabs):
            if i == self._current_tab:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.ACTIVE_BG};
                        color: #ffffff;
                        font-weight: bold;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.ACTIVE_HOVER};
                    }}
                """)
            else:
                btn.setStyleSheet(f"""
                    QPushButton {{
                        background-color: {self.INACTIVE_BG};
                        color: #888;
                        font-size: 9pt;
                        border: none;
                        border-radius: 0px;
                        padding: 4px 8px;
                    }}
                    QPushButton:hover {{
                        background-color: {self.INACTIVE_HOVER};
                        color: #fff;
                    }}
                """)
```

### `core/config.py`

```python
"""Configuration Manager for PyQt6 GUI Framework."""
import os
import json

_DEFAULTS = {
    "window_width": 1200,
    "window_height": 800,
    "theme": "dark",
    "current_service": "Gemini",
    "current_model": "Flash",
    "default_system_prompt": "You are a helpful AI assistant.",
    "splitter_sizes": [780, 420],
    "media_active_tab": 0,
    "gallery_page": 1,
    "gallery_filter": "All",
    "pollinations_positive_prompt": "",
    "pollinations_negative_prompt": "",
    "pollinations_model": "zimage",
    "pollinations_size": "1024x1024",
    "pollinations_seed": -1,
    "pollinations_last_image": "",
    "airforce_positive_prompt": "",
    "airforce_negative_prompt": "",
    "airforce_model": "grok-imagine",
    "airforce_last_image": "",
    "perchance_url": "https://perchance.org/a1481832-0a06-414f-baa6-616052e5f61d",
    "adblocker": {
        "blocked_domains": [
            "a.pub.network",
            "d.pub.network",
            "cdn.snigelweb.com",
            "googletagmanager.com",
            "cloudflareinsights.com",
            "static.criteo.net",
            "secure.quantserve.com",
            "fundingchoicesmessages.google.com"
        ],
        "hidden_selectors": [
            ".ad-providers-ctn-el",
            "#adCtn",
            "#pmLink"
        ]
    },
    "display_fields": {
        "core": True,
        "composition": True,
        "lighting": True,
        "style": True,
        "technical": True,
        "post_processing": True,
        "special_elements": True,
        "detailed_prompt": True,
        "grok_imagine_optimized": True,
        "gemini_optimized": True,
        "flux_optimized": True,
        "stable_diffusion_optimized": True,
        "video_optimized": True
    }
}

class ConfigManager:
    """Manages GUI configuration values and local gui_config.json persistence."""

    def __init__(self, config_file: str = "gui_config.json"):
        self.config_file = config_file
        self.__dict__.update(_DEFAULTS)
        self._load_config()

    def _load_config(self) -> None:
        if not os.path.exists(self.config_file):
            return
        try:
            with open(self.config_file, 'r') as f:
                config = json.load(f)
                for k in _DEFAULTS:
                    val = config.get(k, getattr(self, k))
                    if isinstance(val, dict) and isinstance(_DEFAULTS[k], dict):
                        merged = _DEFAULTS[k].copy()
                        merged.update(val)
                        setattr(self, k, merged)
                    else:
                        setattr(self, k, val)
                if "default_service" in config and "current_service" not in config:
                    self.current_service = config["default_service"]
                if "service_models" in config and "current_model" not in config:
                    self.current_model = config.get("service_models", {}).get(self.current_service, self.current_model)
        except Exception:
            pass

    def save(self) -> None:
        try:
            with open(self.config_file, 'w') as f:
                json.dump({k: getattr(self, k) for k in _DEFAULTS}, f, indent=2)
        except Exception:
            pass
```